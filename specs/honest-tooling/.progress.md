# honest-tooling

## Original Goal
Fix submission tooling for honest labels, batch submissions, and unified CLI. Four changes: (1) aristotle_fetch.py: change "proven" verdict to "compiled_clean", add target_resolved column, update display strings. (2) safe_aristotle_submit.py: split check_recent_submissions() into check_duplicate() + check_rate_limit(), add --batch flag. (3) mk CLI: add submit, status, partials, resubmittable, query commands. (4) Alignment: extract_findings.py status string, audit_proven.py IN clauses.

## Interview Format
- Version: 1.0

## Intent Classification
- Type: REFACTOR
- Confidence: high (3 keywords matched)
- Min questions: 3
- Max questions: 5
- Keywords matched: fix, add, unified

## Interview Responses

### Goal Interview (from start.md)
- Problem: All of the above — honest labels + batch fix + unified CLI + alignment
- Constraints: Don't break active pipeline — all existing submission/fetch commands must keep working
- Success criteria: Honest output labels — no more 'PROVEN' for compilations, says 'COMPILED CLEAN' instead
- Additional context: Detailed plan already exists from prior session with exact code changes for all 5 files

### Requirements Interview (from requirements.md)
- Primary users: Everyone — make it good for all pipeline users
- Priority tradeoffs: Prioritize speed of delivery
- Success criteria: (from goal interview) Honest output labels
- Additional requirements context: Plan already detailed, no more questions needed

## Related Specs
- math-forge [Low]: Overlapping files (mk CLI, extract_findings.py, safe_aristotle_submit.py)

## Completed Tasks
- [x] 1.1 Create migration script and run it against tracking.db
- [x] 1.2 Update aristotle_fetch.py verdict and DB writes
- [x] 1.3 Update aristotle_fetch.py display strings
- [x] 1.4 Update backfill_slots.py status strings
- [x] 1.5 Update backfill_all_files.py status string
- [x] 1.7 Update audit_proven.py SQL and display strings
- [x] 1.8 Update verify_output.sh display strings
- [x] 1.9 Update post_result.sh display strings
- [x] 1.11 Split check_recent_submissions() and add batch mode to safe_aristotle_submit.py
- [x] 1.12 Add 5 new mk CLI commands

## Current Task
Awaiting next task

## Next
Task 1.13: POC Checkpoint

## Learnings
- tracking.db has 203 rows with status='proven' (189 verified=1). All need migration to 'compiled_clean'.
- knowledge.db uses 'proven' in problems.status and strategies.outcome with CHECK constraints. These are semantically correct (problem-level, not submission-level) and should NOT be changed.
- safe_aristotle_submit.py check_recent_submissions() makes an API call to Project.list_projects() AND check_queue_capacity() makes another -- splitting the function should also merge these to avoid double API calls.
- context-loader.sh queries verified=1 AND sorry_count=0, not status='proven', so it needs no change.
- mk CLI's [PROVEN] badge in search results refers to finding_type='theorem', not submission status -- should stay as-is.
- backfill_slots.py and backfill_all_files.py also set status='proven' -- they're not in the original 5-file list but need updating.
- verify_output.sh has "PROVEN" display strings that should be updated for consistency.
- No package.json, Makefile, or CI configs exist. Only quality check is `bats math-forge/tests/`.
- target_resolved column does not exist in submissions table yet. SQLite ALTER TABLE ADD COLUMN is straightforward.
- knowledge.db schema.sql CHECK constraints can't be ALTER-ed in SQLite -- table recreation required if changed. This reinforces leaving knowledge.db alone.
- Requirements: extract_findings.py explicitly out of scope -- its 'proven' status goes to knowledge.db problems table, not tracking.db.
- Requirements: audit_proven.py IN clauses need BOTH 'proven' and 'compiled_clean' for backward compat with any unmigrated data.
- Requirements: mk query raises safety concern -- destructive SQL possible. Recommend read-only wrapper.
- Requirements: Migration is idempotent -- running UPDATE twice has no effect since no rows match 'proven' after first run.
- Requirements: 15 functional requirements across 3 priority levels. P0 = honest labels (5 FRs), P1 = batch + CLI (7 FRs), P2 = nice-to-haves (3 FRs).
- Design: check_duplicate() is synchronous (no async needed) since it only reads local transaction log file. Simpler than the original which was async only because the API call was bundled in.
- Design: check_rate_limit_and_capacity() merges two former functions into one, reducing API calls from 2 to 1 per submission. Uses single list_projects(limit=20) call.
- Design: mk query uses shell case statement on uppercased first word to enforce SELECT-only. Not bulletproof (e.g. "SELECT 1; DROP TABLE") but sqlite3 CLI doesn't execute multiple statements by default.
- Design: Batch mode still runs check_duplicate() per file (fast, local). Only skips rate-limit/capacity interactive check. This prevents resubmitting the same sketch within a batch.
- Design: 9 files modified total (1 new migration script + 8 existing files). 46 individual edits across all files.
- Design: post_result.sh line 53 references literature_lemmas.proof_status='proven' -- left unchanged because it's a different table with different semantics.
- Design: safe_aristotle_submit.py CLI rewrite is the largest change -- replaces the entire __main__ block with proper arg parsing and batch loop. Single-file mode behavior preserved exactly.
- Task planning: 21 tasks across 5 phases. Phase 1 (POC) has 13 tasks covering all 9 files. Migration runs first since all code changes depend on it.
- Task planning: safe_aristotle_submit.py task (1.11) is the largest single task -- 7 change areas. Design has complete before/after code for all changes. Keep as one task since the function split, batch param, and CLI rewrite are tightly coupled.
- Task planning: Quality checkpoints inserted after tasks 1.5, 1.9, 2.1, 3.3, and as final verification. Only automated check available is `bats math-forge/tests/` plus grep scans.
- Task planning: No VF task needed -- .progress.md has no "Reality Check (BEFORE)" section. This is a REFACTOR spec, not a fix spec.
- Task planning: Dependency chain is linear: migration (1.1) -> writers (1.2-1.5) -> readers (1.7) -> display (1.8-1.9) -> submit (1.11) -> CLI (1.12). But writers/display can run in parallel after migration.
- aristotle_fetch.py: 9 edits total across tasks 1.2+1.3. All mechanical replacements. Zero remaining "proven"/"PROVEN" string references in the file after edits.
- audit_proven.py: 10 edits (docstring, 3 IN clauses with backward-compat 'proven'+'compiled_clean', 2 comments, 4 display strings). Script correctly picks up 203 compiled_clean rows.
- verify_output.sh: 5 edits -- display strings only. CLAIMED_PROVEN variable name kept (internal). All "proven" in display strings replaced with "compiled clean" or "COMPILED CLEAN".
- post_result.sh: 2 edits -- line 42 success message and line 44 extraction header. Line 53 (literature_lemmas proof_status='proven') stays as-is per design.
- mk CLI: 5 new commands (submit, status, partials, resubmittable, query) + help update. All inserted before help|*) catch-all. Query safety enforces SELECT/WITH/EXPLAIN/PRAGMA only via uppercased case match. Help grep returns 10 matches (5 command names appear in both "Pipeline commands" and "Examples" sections).
- safe_aristotle_submit.py: 7 change areas applied. check_duplicate() is sync (no async), check_rate_limit_and_capacity() merges former check_recent_submissions+check_queue_capacity into single API call. Batch mode skips rate-limit check but still runs duplicate check per file. CLI rewrite uses proper arg parsing loop (not list comprehension) with --context consuming next arg. resolve_file() helper handles slot detection for batch mode. 12 total occurrences of 'batch' in final file.
