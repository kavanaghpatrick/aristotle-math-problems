/-
This file was generated by Aristotle (https://aristotle.harmonic.fun).

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 4580f5d3-a6ff-4bb6-b451-b8cd0df398fd

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>
-/

/-
We prove Erdős Problem 370: there are infinitely many n such that the largest prime factor P(n) < √n and P(n+1) < √(n+1).
We define `Nat.maxPrimeFac n` as the largest prime factor of `n`.
We prove the result by exhibiting the infinite family n = p^4 - 1 for odd primes p.
We establish helper lemmas `Nat.maxPrimeFac_mul`, `Nat.maxPrimeFac_pow`, `Nat.maxPrimeFac_le_self`, `Nat.maxPrimeFac_le_half`, and `Nat.maxPrimeFac_p_sq_add_one_le` to bound the prime factors.
We show that for n = p^4 - 1, P(n) ≤ (p^2+1)/2 < √(p^4-1) and P(n+1) = p < p^2 = √(n+1).
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
The largest prime factor of n.
-/
def Nat.maxPrimeFac (n : ℕ) : ℕ := n.primeFactors.max.getD 0

/-
The largest prime factor of a product is the maximum of the largest prime factors of the factors.
-/
lemma Nat.maxPrimeFac_mul {a b : ℕ} (ha : a ≠ 0) (hb : b ≠ 0) :
    Nat.maxPrimeFac (a * b) = max (Nat.maxPrimeFac a) (Nat.maxPrimeFac b) := by
      -- The prime factors of $a * b$ are the union of the prime factors of $a$ and $b$.
      have h_prime_factors : (a * b).primeFactors = a.primeFactors ∪ b.primeFactors := by
        exact Nat.primeFactors_mul ha hb;
      -- The maximum of a set is the largest element in it.
      unfold Nat.maxPrimeFac;
      cases h : a.primeFactors.max <;> cases h' : b.primeFactors.max <;> simp_all +decide [ Finset.max_eq_sup_coe, Finset.sup_union ];
      · rw [ show a.primeFactors = ∅ by ext x; aesop ] ; rfl;
      · exact Nat.zero_le _;
      · exact Nat.zero_le _;
      · exact?

/-
The largest prime factor of a prime power is the prime itself.
-/
lemma Nat.maxPrimeFac_pow {p k : ℕ} (hp : p.Prime) (hk : k ≠ 0) :
    Nat.maxPrimeFac (p ^ k) = p := by
      -- Since the prime factors of $p^k$ are just $\{p\}$, the maximum prime factor is $p$.
      have h_max_prime_factor : (p ^ k).primeFactors = {p} := by
        rw [ Nat.primeFactors_pow ] <;> norm_num [ hp, hk ];
      unfold Nat.maxPrimeFac; simp +decide [ h_max_prime_factor ] ;
      rfl

/-
The largest prime factor of n is less than or equal to n.
-/
lemma Nat.maxPrimeFac_le_self {n : ℕ} : Nat.maxPrimeFac n ≤ n := by
  -- By definition, the maximum prime factor of $n$ is a prime factor of $n$, so it must be less than or equal to $n$.
  by_cases hn : n = 0 ∨ n = 1;
  · rcases hn with ( rfl | rfl ) <;> native_decide;
  · -- Since $n \neq 0$ and $n \neq 1$, its largest prime factor is well-defined and must be a prime number that divides $n$.
    have h_prime_factor : ∃ p, Nat.Prime p ∧ p ∣ n ∧ ∀ q, Nat.Prime q → q ∣ n → q ≤ p := by
      exact ⟨ Finset.max' ( Nat.primeFactors n ) ( Finset.nonempty_of_ne_empty ( by aesop ) ), Nat.prime_of_mem_primeFactors ( Finset.max'_mem _ _ ), Nat.dvd_of_mem_primeFactors ( Finset.max'_mem _ _ ), fun q hq hqn => Finset.le_max' _ _ ( by aesop ) ⟩;
    obtain ⟨ p, hp₁, hp₂, hp₃ ⟩ := h_prime_factor;
    -- Since $p$ is a prime factor of $n$, we have $n.maxPrimeFac = p$.
    have h_max_eq_p : n.maxPrimeFac = p := by
      unfold Nat.maxPrimeFac;
      rw [ show n.primeFactors.max = p from ?_ ];
      · rfl;
      · exact le_antisymm ( Finset.sup_le fun q hq => WithBot.coe_le_coe.mpr <| hp₃ q ( Nat.prime_of_mem_primeFactors hq ) <| Nat.dvd_of_mem_primeFactors hq ) ( Finset.le_sup ( f := WithBot.some ) <| by aesop );
    exact h_max_eq_p.symm ▸ Nat.le_of_dvd ( Nat.pos_of_ne_zero ( by tauto ) ) hp₂

/-
If n is even and greater than 2, its largest prime factor is at most n/2.
-/
lemma Nat.maxPrimeFac_le_half {n : ℕ} (hn : n % 2 = 0) (hn2 : n > 2) :
    Nat.maxPrimeFac n ≤ n / 2 := by
      -- Since n is even and greater than 2, n = 2 * m where m > 1.
      obtain ⟨m, hm⟩ : ∃ m, n = 2 * m ∧ 1 < m := by
        exact ⟨ n / 2, by rw [ Nat.mul_div_cancel' ( Nat.dvd_of_mod_eq_zero hn ) ], by linarith [ Nat.mod_add_div n 2 ] ⟩;
      -- By definition of maxPrimeFac, we know that maxPrimeFac n = max (maxPrimeFac 2) (maxPrimeFac m).
      have h_max_prime_fac : Nat.maxPrimeFac n = max (Nat.maxPrimeFac 2) (Nat.maxPrimeFac m) := by
        convert Nat.maxPrimeFac_mul _ _ using 1 <;> aesop;
      -- Since $m > 1$, we have $Nat.maxPrimeFac m \leq m$.
      have h_max_prime_fac_m : Nat.maxPrimeFac m ≤ m := by
        exact Nat.maxPrimeFac_le_self;
      simp_all +decide [ Nat.maxPrimeFac ];
      exact hm.2

/-
If p is an odd prime, the largest prime factor of p^2+1 is at most (p^2+1)/2.
-/
lemma Nat.maxPrimeFac_p_sq_add_one_le {p : ℕ} (hp : p.Prime) (hp_odd : p % 2 = 1) :
    Nat.maxPrimeFac (p ^ 2 + 1) ≤ (p ^ 2 + 1) / 2 := by
      convert Nat.maxPrimeFac_le_half _ _ using 1;
      · norm_num [ Nat.add_mod, Nat.pow_mod, hp_odd ];
      · nlinarith [ hp.two_le ]

/-
Inequality helper for Erdos 370.
-/
lemma inequality_aux (p : ℕ) (hp : p ≥ 3) : ((p^2 + 1) / 2 : ℝ) < Real.sqrt (p^4 - 1) := by
  refine' Real.lt_sqrt_of_sq_lt _ ; nlinarith [ show ( p : ℝ ) ≥ 3 by norm_cast, sq ( p - 1 : ℝ ) ] ;

/-
There are infinitely many n such that the largest prime factor P(n) < √n AND P(n+1) < √(n+1).
-/
def answer (b : Bool) := b = true

theorem erdos_370 : answer true ↔
    { n | (Nat.maxPrimeFac n : ℝ) < Real.sqrt n ∧ (Nat.maxPrimeFac (n + 1) : ℝ) < Real.sqrt (n + 1) }.Infinite := by
      unfold answer;
      simp +zetaDelta at *;
      -- Consider the family $n = p^4 - 1$ for odd primes $p \geq 3$.
      have h_family : ∀ p : ℕ, Nat.Prime p → p ≥ 3 → p % 2 = 1 → (Nat.maxPrimeFac (p^4 - 1) : ℝ) < Real.sqrt (p^4 - 1) ∧ (Nat.maxPrimeFac (p^4) : ℝ) < Real.sqrt (p^4) := by
        intro p hp hp3 hp_odd
        constructor;
        · -- By `Nat.maxPrimeFac_mul`, $P(p^4 - 1) = \max(P(p-1), P(p+1), P(p^2+1))$.
          have h_max_prime_fac : Nat.maxPrimeFac (p^4 - 1) ≤ max (max (p - 1) (p + 1)) ((p^2 + 1) / 2) := by
            have h_max_prime_fac : Nat.maxPrimeFac (p^4 - 1) = Nat.max (Nat.max (Nat.maxPrimeFac (p - 1)) (Nat.maxPrimeFac (p + 1))) (Nat.maxPrimeFac (p^2 + 1)) := by
              rw [ show p ^ 4 - 1 = ( p - 1 ) * ( p + 1 ) * ( p ^ 2 + 1 ) by zify ; cases p <;> norm_num ; ring ];
              rw [ Nat.maxPrimeFac_mul, Nat.maxPrimeFac_mul ] <;> norm_num [ hp.ne_zero, hp.ne_one ];
              · omega;
              · omega;
            -- By `Nat.maxPrimeFac_le_self`, $P(p-1) \leq p-1$ and $P(p+1) \leq p+1$.
            have h_max_prime_fac_le_self : Nat.maxPrimeFac (p - 1) ≤ p - 1 ∧ Nat.maxPrimeFac (p + 1) ≤ p + 1 := by
              exact ⟨ Nat.maxPrimeFac_le_self, Nat.maxPrimeFac_le_self ⟩;
            -- By `Nat.maxPrimeFac_p_sq_add_one_le`, $P(p^2+1) \leq (p^2+1)/2$.
            have h_max_prime_fac_p_sq_add_one_le : Nat.maxPrimeFac (p^2 + 1) ≤ (p^2 + 1) / 2 := by
              convert Nat.maxPrimeFac_p_sq_add_one_le hp hp_odd using 1;
            exact h_max_prime_fac.symm ▸ max_le_max ( max_le_max h_max_prime_fac_le_self.1 h_max_prime_fac_le_self.2 ) h_max_prime_fac_p_sq_add_one_le;
          refine' lt_of_le_of_lt ( Nat.cast_le.mpr h_max_prime_fac ) _;
          rcases p with ( _ | _ | p ) <;> norm_num at *;
          rw [ Nat.cast_div ] <;> norm_num <;> ring <;> norm_num;
          · exact ⟨ Real.lt_sqrt_of_sq_lt ( by nlinarith ), Real.lt_sqrt_of_sq_lt ( by nlinarith ) ⟩;
          · norm_num [ ← even_iff_two_dvd, parity_simps ];
            exact Nat.odd_iff.mpr ( by omega );
        · -- By `Nat.maxPrimeFac_pow`, we have $P(p^4) = p$.
          have h_max_prime_fac_p4 : Nat.maxPrimeFac (p^4) = p := by
            exact Nat.maxPrimeFac_pow hp ( by decide );
          exact h_max_prime_fac_p4.symm ▸ Real.lt_sqrt_of_sq_lt ( by norm_cast; nlinarith [ Nat.pow_le_pow_left hp3 2 ] );
      rw [ Set.infinite_iff_exists_gt ];
      intro a
      obtain ⟨p, hp_prime, hp_ge, hp_odd⟩ : ∃ p : ℕ, Nat.Prime p ∧ p ≥ 3 ∧ p % 2 = 1 ∧ a < p^4 - 1 := by
        rcases Nat.exists_infinite_primes ( a + 4 ) with ⟨ p, hp₁, hp₂ ⟩ ; exact ⟨ p, hp₂, by linarith, hp₂.eq_two_or_odd.resolve_left ( by linarith ), lt_tsub_iff_right.mpr ( by nlinarith [ Nat.pow_le_pow_left ( show p ≥ 2 by linarith ) 2, Nat.pow_le_pow_left ( show p ≥ 2 by linarith ) 3 ] ) ⟩;
      use p^4 - 1;
      convert h_family p hp_prime hp_ge hp_odd.1 using 2 ; norm_num [ Nat.cast_sub ( show 1 ≤ p ^ 4 from Nat.one_le_pow _ _ hp_prime.pos ) ];
      · exact fun h => by simpa [ Nat.sub_add_cancel ( Nat.one_le_pow _ _ hp_prime.pos ) ] using h_family p hp_prime hp_ge hp_odd.1 |>.2;
      · grind