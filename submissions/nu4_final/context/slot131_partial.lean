/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: ae553796-8ef2-4a6e-bf85-4c6aa7ba16f3

Aristotle's budget for this request has been reached.
If there is partial progress, it will appear in this file.
If you would like to continue working off of this partial progress,
please submit the same prompt, and add this .lean file in "Optional: Attach a Lean file as context" field.

-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

open scoped BigOperators Classical


variable {V : Type*} [Fintype V] [DecidableEq V]

def isTrianglePacking (G : SimpleGraph V) [DecidableRel G.Adj] (S : Finset (Finset V)) : Prop :=
  S ⊆ G.cliqueFinset 3 ∧
  Set.Pairwise (S : Set (Finset V)) (fun t1 t2 => (t1 ∩ t2).card ≤ 1)

noncomputable def trianglePackingNumber (G : SimpleGraph V) [DecidableRel G.Adj] : ℕ :=
  (G.cliqueFinset 3).powerset.filter (isTrianglePacking G) |>.image Finset.card |>.max |>.getD 0

def isMaxPacking (G : SimpleGraph V) [DecidableRel G.Adj] (M : Finset (Finset V)) : Prop :=
  isTrianglePacking G M ∧ M.card = trianglePackingNumber G

/-- M-edges incident to vertex v -/
def M_edges_at (M : Finset (Finset V)) (v : V) : Finset (Sym2 V) :=
  M.biUnion (fun X => X.sym2.filter (fun e => v ∈ e))

/-- Triangles that share an M-edge containing v -/
def trianglesSharingMEdgeAt (G : SimpleGraph V) [DecidableRel G.Adj]
    (M : Finset (Finset V)) (v : V) : Finset (Finset V) :=
  (G.cliqueFinset 3).filter (fun t => ∃ e ∈ M_edges_at M v, e ∈ t.sym2)

/-- External triangles at v: those sharing M-edge at v but NOT in M -/
def externalTrianglesAt (G : SimpleGraph V) [DecidableRel G.Adj]
    (M : Finset (Finset V)) (v : V) : Finset (Finset V) :=
  trianglesSharingMEdgeAt G M v \ M

structure Cycle4 (G : SimpleGraph V) [DecidableRel G.Adj] (M : Finset (Finset V)) where
  A : Finset V
  B : Finset V
  C : Finset V
  D : Finset V
  hA : A ∈ M
  hB : B ∈ M
  hC : C ∈ M
  hD : D ∈ M
  hM_eq : M = {A, B, C, D}
  v_ab : V
  v_bc : V
  v_cd : V
  v_da : V
  hAB : A ∩ B = {v_ab}
  hBC : B ∩ C = {v_bc}
  hCD : C ∩ D = {v_cd}
  hDA : D ∩ A = {v_da}
  h_vab_A : v_ab ∈ A
  h_vab_B : v_ab ∈ B
  h_vbc_B : v_bc ∈ B
  h_vbc_C : v_bc ∈ C
  h_vcd_C : v_cd ∈ C
  h_vcd_D : v_cd ∈ D
  h_vda_D : v_da ∈ D
  h_vda_A : v_da ∈ A
  h_diag_AC : (A ∩ C).card ≤ 1
  h_diag_BD : (B ∩ D).card ≤ 1
  -- Distinctness (from slot127 proven)
  h_vab_ne_vbc : v_ab ≠ v_bc
  h_vbc_ne_vcd : v_bc ≠ v_cd
  h_vcd_ne_vda : v_cd ≠ v_da
  h_vda_ne_vab : v_da ≠ v_ab

lemma triangle_card_eq_3 (G : SimpleGraph V) [DecidableRel G.Adj]
    (t : Finset V) (ht : t ∈ G.cliqueFinset 3) : t.card = 3 := by
      -- By definition of `cliqueFinset`, if `t` is in `cliqueFinset 3`, then `t` has exactly 3 elements.
      simp [SimpleGraph.cliqueFinset] at ht; exact ht.2

lemma mem_inter_iff' (v : V) (A B : Finset V) : v ∈ A ∩ B ↔ v ∈ A ∧ v ∈ B := by
  -- By definition of intersection, v is in A ∩ B if and only if v is in both A and B.
  simp [Finset.mem_inter]

lemma triangle_sharing_M_edge_contains_v (G : SimpleGraph V) [DecidableRel G.Adj]
    (M : Finset (Finset V)) (v : V) (t : Finset V)
    (ht : t ∈ trianglesSharingMEdgeAt G M v) : v ∈ t := by
      -- By definition of `trianglesSharingMEdgeAt`, if `t` is in this set, then there exists an edge `e` in `M_edges_at M v` that is also in `t.sym2`.
      obtain ⟨e, heM, heT⟩ : ∃ e ∈ M_edges_at M v, e ∈ t.sym2 := by
        unfold trianglesSharingMEdgeAt at ht; aesop;
      unfold M_edges_at at heM; aesop;

lemma external_triangle_contains_v (G : SimpleGraph V) [DecidableRel G.Adj]
    (M : Finset (Finset V)) (v : V) (t : Finset V)
    (ht : t ∈ externalTrianglesAt G M v) : v ∈ t := by
      -- By definition of `trianglesSharingMEdgeAt`, if $t$ is in this set, then $t$ is a triangle that shares an $M$-edge at $v$. Since $t$ is a triangle, it must have three vertices, one of which is $v$. Therefore, $v$ must be in $t$.
      have ht_triangle : t ∈ trianglesSharingMEdgeAt G M v → v ∈ t := by
        intro ht_triangle
        obtain ⟨e, heM, hev⟩ : ∃ e ∈ M_edges_at M v, e ∈ t.sym2 := by
          unfold trianglesSharingMEdgeAt at ht_triangle; aesop;
        unfold M_edges_at at heM; aesop;
      -- Since $t$ is in the external triangles at $v$, it must be in the triangles sharing an $M$-edge at $v$.
      apply ht_triangle; exact Finset.mem_sdiff.mp ht |>.1

/-
v_ab is not in C and not in D.
-/
lemma v_ab_notin_C (G : SimpleGraph V) [DecidableRel G.Adj]
    (M : Finset (Finset V)) (cfg : Cycle4 G M) :
    cfg.v_ab ∉ cfg.C := by
  intro h
  have h_in_B : cfg.v_ab ∈ cfg.B := cfg.h_vab_B
  have h_in_inter : cfg.v_ab ∈ cfg.B ∩ cfg.C := Finset.mem_inter.mpr ⟨h_in_B, h⟩
  rw [cfg.hBC] at h_in_inter
  have h_eq : cfg.v_ab = cfg.v_bc := Finset.mem_singleton.mp h_in_inter
  exact cfg.h_vab_ne_vbc h_eq

lemma v_ab_notin_D (G : SimpleGraph V) [DecidableRel G.Adj]
    (M : Finset (Finset V)) (cfg : Cycle4 G M) :
    cfg.v_ab ∉ cfg.D := by
  intro h
  have h_in_A : cfg.v_ab ∈ cfg.A := cfg.h_vab_A
  have h_in_inter : cfg.v_ab ∈ cfg.D ∩ cfg.A := Finset.mem_inter.mpr ⟨h, h_in_A⟩
  rw [cfg.hDA] at h_in_inter
  have h_eq : cfg.v_ab = cfg.v_da := Finset.mem_singleton.mp h_in_inter
  exact cfg.h_vda_ne_vab.symm h_eq

/-
If T intersects C in >= 2 vertices, then the two vertices of T other than v_ab are in C.
-/
lemma external_triangle_subset_C_of_inter_ge_2 (G : SimpleGraph V) [DecidableRel G.Adj]
    (M : Finset (Finset V)) (cfg : Cycle4 G M)
    (T : Finset V) (hT : T ∈ externalTrianglesAt G M cfg.v_ab)
    (h_inter : (T ∩ cfg.C).card ≥ 2) :
    T \ {cfg.v_ab} ⊆ cfg.C := by
      -- Since $v_{ab} \notin C$, the intersection $T \cap C$ is a subset of $T \setminus \{v_{ab}\}$.
      have h_inter_subset : T ∩ cfg.C ⊆ T \ {cfg.v_ab} := by
        simp_all +decide [ Finset.subset_iff ];
        exact fun x hxT hxC hx => v_ab_notin_C G M cfg <| hx ▸ hxC;
      have h_inter_eq_T_minus_v_ab : T ∩ cfg.C = T \ {cfg.v_ab} := by
        refine' Finset.eq_of_subset_of_card_le _ _;
        · assumption;
        · have := triangle_card_eq_3 G T ( by { exact Finset.mem_filter.mp ( Finset.mem_sdiff.mp hT |>.1 ) |>.1 } ) ; simp_all +decide [ Finset.card_sdiff ] ;
          by_cases h : cfg.v_ab ∈ T <;> simp_all +decide;
          exact absurd ( external_triangle_contains_v G M cfg.v_ab T hT ) h;
      exact h_inter_eq_T_minus_v_ab ▸ Finset.inter_subset_right