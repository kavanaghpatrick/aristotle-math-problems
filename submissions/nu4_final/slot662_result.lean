/-
This file was generated by Aristotle (https://aristotle.harmonic.fun).

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 43d74efd-fcc7-41e9-8172-f25933931c1b

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>

Aristotle's budget for this request has been reached.
If there is partial progress, it will appear in this file.
If you would like to continue working off of this partial progress,
please submit the same prompt, and add this .lean file in "Optional: Attach a Lean file as context" field.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

#check Squarefree

example : Decidable (Squarefree 10) := inferInstance
#eval (decide (Squarefree 10))

/-
A computable function to check Erdős Problem 11 for a given n, and a proof that it implies the existential statement.
-/
def check_erdos_11 (n : ℕ) : Bool :=
  (List.range (Nat.log2 n + 1)).any fun l =>
    let k := n - 2^l
    decide (k > 0 ∧ Squarefree k)

theorem check_erdos_11_correct (n : ℕ) (h : check_erdos_11 n = true) :
    ∃ k l : ℕ, Squarefree k ∧ n = k + 2 ^ l := by
      unfold check_erdos_11 at h;
      grind

/-
A computable function to check Erdős Problem 11 for a range, and a proof that it implies the bounded conjecture.
-/
def check_erdos_11_range (limit : ℕ) : Bool :=
  (List.range limit).all fun n =>
    if n % 2 == 1 && n > 1 then check_erdos_11 n else true

theorem erdos_11_bounded_of_check (limit : ℕ) (h : check_erdos_11_range limit = true) :
    ∀ n < limit, Odd n → 1 < n → ∃ k l, Squarefree k ∧ n = k + 2 ^ l := by
      -- By definition of `check_erdos_11_range`, if `check_erdos_11_range limit` is true, then for all `n` such that `0 ≤ n < limit`, if `Odd n` and `1 < n`, then `check_erdos_11 n` must be true.
      have h_check_all : ∀ n, 0 ≤ n → n < limit → Odd n → 1 < n → check_erdos_11 n = Bool.true := by
        unfold check_erdos_11_range at h;
        grind;
      exact fun n hn hn' hn'' => check_erdos_11_correct n ( h_check_all n ( Nat.zero_le n ) hn hn' hn'' )

/-
Verification of Erdős Problem 11 for n < 1000.
-/
theorem erdos_11_upto_1000 : check_erdos_11_range 1000 = true := by native_decide

/-
Definition of a Wieferich prime: a prime p such that 2^(p-1) ≡ 1 (mod p^2).
-/
def IsWieferichPrime (p : ℕ) : Prop :=
  p.Prime ∧ 2 ^ (p - 1) ≡ 1 [MOD p ^ 2]

/-
Definitions for the set of candidates n - 2^k and a function to count those divisible by p^2.
-/
def erdos_candidates (n : ℕ) : Finset ℕ :=
  (Finset.range (Nat.log2 n + 1)).image (fun k => n - 2^k)

def count_divisible_candidates (n p : ℕ) : ℕ :=
  (erdos_candidates n).filter (fun m => m % (p^2) == 0) |>.card

lemma candidates_subset (n : ℕ) : erdos_candidates n ⊆ Finset.range (n + 1) := by
  exact Finset.subset_iff.mpr fun x hx => Finset.mem_range.mpr ( by obtain ⟨ y, hy, rfl ⟩ := Finset.mem_image.mp hx; linarith [ Nat.sub_le n ( 2 ^ y ) ] )

/-
Definition of natural density: A set A has natural density d if the proportion of elements in A below n converges to d as n goes to infinity.
-/
def HasNaturalDensity (A : Set ℕ) (d : ℝ) : Prop :=
  Filter.Tendsto (fun n => ((Finset.range n).filter (fun k => k ∈ A)).card / (n : ℝ)) Filter.atTop (nhds d)

/-
The statement of Erdős Problem 11: Every odd n > 1 is the sum of a squarefree number and a power of 2.
-/
def Erdos11Statement : Prop :=
  ∀ n : ℕ, Odd n → 1 < n → ∃ k l : ℕ, Squarefree k ∧ n = k + 2 ^ l