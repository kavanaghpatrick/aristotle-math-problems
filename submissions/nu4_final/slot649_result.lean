/-
This file was generated by Aristotle (https://aristotle.harmonic.fun).

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 1f431a4f-4cda-4478-a95c-f6dfdb84264d

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>
-/

/-
Formalization of Gilbreath's Conjecture.
We define the iterated absolute difference sequence `d` on primes.
We prove that `d^k(0)` is odd for all `k >= 1` and `d^k(n)` is even for all `k >= 1, n >= 1`.
We verify the conjecture `d^k(0) = 1` for `k = 1, ..., 10`.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
Definition of the iterated absolute difference sequence d^k(n).
d^0(n) is the n-th prime number.
d^{k+1}(n) is the absolute difference |d^k(n+1) - d^k(n)|.
-/
noncomputable def d : ℕ → (ℕ → ℕ)
  | 0 => fun n ↦ Nat.nth Nat.Prime n
  | k + 1 => fun n ↦ Int.natAbs ((d k (n + 1) : Int) - (d k n : Int))

/-
Helper lemma stating the first few values of the prime sequence.
-/
lemma nth_prime_vals :
    Nat.nth Nat.Prime 0 = 2 ∧
    Nat.nth Nat.Prime 1 = 3 ∧
    Nat.nth Nat.Prime 2 = 5 ∧
    Nat.nth Nat.Prime 3 = 7 ∧
    Nat.nth Nat.Prime 4 = 11 := by
      bound

/-
Verification of Gilbreath's conjecture for k=1.
-/
theorem gilbreath_1 : d 1 0 = 1 := by
  -- By definition of $d$, we know that $d 1 0 = |d 0 1 - d 0 0|$.
  have h_base : d 1 0 = Int.natAbs ((Nat.nth Nat.Prime 1 : ℤ) - (Nat.nth Nat.Prime 0 : ℤ)) := by
    rfl;
  rw [ h_base, nth_prime_vals.1, nth_prime_vals.2.1 ] ; norm_num

/-
Verification of Gilbreath's conjecture for k=2.
-/
theorem gilbreath_2 : d 2 0 = 1 := by
  -- By definition of $d$, we know that $d^1(0) = 1$, $d^1(1) = 2$, $d^1(2) = 2$, $d^1(3) = 4$, and so on.
  have h_diff_1 : d 1 0 = 1 ∧ d 1 1 = 2 ∧ d 1 2 = 2 ∧ d 1 3 = 4 := by
    -- By definition of $d$, we know that $d^1(n) = |p_{n+1} - p_n|$ for all $n$ where $p_n$ is the $n$-th prime number.
    have h_diff : ∀ n, d 1 n = Int.natAbs ((Nat.nth Nat.Prime (n + 1) : ℤ) - (Nat.nth Nat.Prime n : ℤ)) := by
      bound;
    norm_num [ h_diff, nth_prime_vals ];
  exact show Int.natAbs ( ( d 1 1 : ℤ ) - d 1 0 ) = 1 from by norm_num [ h_diff_1 ] ;

/-
Verification of Gilbreath's conjecture for k=3.
-/
theorem gilbreath_3 : d 3 0 = 1 := by
  -- By definition of $d$, we know that $d^1(n) = |p_{n+1} - p_n|$.
  have hd1 : ∀ n, d 1 n = Int.natAbs (Nat.nth Nat.Prime (n + 1) - Nat.nth Nat.Prime n) := by
    exact?;
  rw [ show d 3 0 = Int.natAbs ( d 2 1 - d 2 0 ) by rfl, show d 2 0 = Int.natAbs ( d 1 1 - d 1 0 ) by rfl, show d 2 1 = Int.natAbs ( d 1 2 - d 1 1 ) by rfl, hd1, hd1, hd1 ] ; norm_num [ nth_prime_vals ]

/-
Lemma: The first iteration d^1 starts with an odd number, and all subsequent terms are even.
-/
lemma gilbreath_1_parity : Odd (d 1 0) ∧ ∀ n ≥ 1, Even (d 1 n) := by
  have h_odd_pos : ∀ n ≥ 1, Nat.Prime (Nat.nth Nat.Prime n) ∧ Nat.Prime (Nat.nth Nat.Prime (n + 1)) ∧ Odd (Nat.nth Nat.Prime n) ∧ Odd (Nat.nth Nat.Prime (n + 1)) := by
    intro n hn;
    refine' ⟨ Nat.prime_nth_prime _, Nat.prime_nth_prime _, _, _ ⟩;
    · exact Nat.Prime.odd_of_ne_two ( Nat.prime_nth_prime n ) ( ne_of_gt <| Nat.lt_of_le_of_lt ( Nat.Prime.two_le <| Nat.prime_nth_prime 0 ) <| Nat.nth_strictMono ( Nat.infinite_setOf_prime ) <| by linarith );
    · exact Nat.Prime.odd_of_ne_two ( Nat.prime_nth_prime _ ) ( ne_of_gt <| Nat.lt_of_le_of_lt ( Nat.Prime.two_le <| Nat.prime_nth_prime _ ) <| Nat.nth_strictMono ( Nat.infinite_setOf_prime ) <| Nat.lt_succ_self _ );
  -- Since the difference of two odd numbers is even, we have that $d^1(n)$ is even for $n \geq 1$.
  have h_even_diff : ∀ n ≥ 1, Even ((Nat.nth Nat.Prime (n + 1) : ℤ) - (Nat.nth Nat.Prime n : ℤ)) := by
    grind;
  exact ⟨ by rw [ show d 1 0 = 1 from gilbreath_1 ] ; decide, fun n hn => by simpa [ d ] using h_even_diff n hn ⟩

/-
Lemma: For all k >= 1, d^k(0) is odd and d^k(n) is even for all n >= 1.
-/
lemma gilbreath_parity (k : ℕ) (hk : k ≥ 1) : Odd (d k 0) ∧ ∀ n ≥ 1, Even (d k n) := by
  -- We prove this by induction on $k$.
  induction' k, Nat.succ_le.mpr hk using Nat.le_induction with k ih;
  · exact?;
  · -- By definition of $d$, we have $d (k + 1) 0 = |d k 1 - d k 0|$.
    have h_diff0 : d (k + 1) 0 = Int.natAbs ((d k 1 : ℤ) - (d k 0 : ℤ)) := by
      rfl;
    -- By definition of $d$, we have $d (k + 1) n = |d k (n + 1) - d k n|$ for $n \geq 1$.
    have h_diff : ∀ n ≥ 1, d (k + 1) n = Int.natAbs ((d k (n + 1) : ℤ) - (d k n : ℤ)) := by
      exact?;
    simp_all +decide [ parity_simps ];
    exact iff_of_false ( by simpa using ‹Odd ( d k 0 ) ∧ ∀ n : ℕ, 1 ≤ n → Even ( d k n ) ›.2 1 le_rfl ) ( by simpa using ‹Odd ( d k 0 ) ∧ ∀ n : ℕ, 1 ≤ n → Even ( d k n ) ›.1 )

/-
Verification of Gilbreath's conjecture for k=4.
-/
theorem gilbreath_4 : d 4 0 = 1 := by
  -- By definition of $d$, we know that $d^4(0) = |d^3(1) - d^3(0)|$.
  have h_d4_0 : d 4 0 = Int.natAbs ((d 3 1 : ℤ) - (d 3 0 : ℤ)) := by
    rfl;
  -- By definition of $d$, we know that $d^3(0) = 1$ and $d^3(1) = 2$.
  have h_d3_0 : d 3 0 = 1 := by
    exact?
  have h_d3_1 : d 3 1 = 2 := by
    -- By definition of $d$, we know that $d^2(1) = 0$ and $d^2(2) = 2$.
    have h_d2_1 : d 2 1 = 0 := by
      -- By definition of $d$, we know that $d^2(1) = |d^1(2) - d^1(1)|$.
      have h_d2_1 : d 2 1 = Int.natAbs ((d 1 2 : ℤ) - (d 1 1 : ℤ)) := by
        rfl;
      -- By definition of $d$, we know that $d^1(1) = 2$ and $d^1(2) = 2$.
      have h_d1_1 : d 1 1 = 2 := by
        -- By definition of $d$, we know that $d^1(1) = |p_2 - p_1|$.
        have h_d1_1 : d 1 1 = Int.natAbs ((Nat.nth Nat.Prime 2 : ℤ) - (Nat.nth Nat.Prime 1 : ℤ)) := by
          rfl;
        norm_num [ h_d1_1, nth_prime_vals ]
      have h_d1_2 : d 1 2 = 2 := by
        -- By definition of $d$, we know that $d^1(2) = |d^0(3) - d^0(2)|$.
        have h_d1_2 : d 1 2 = Int.natAbs ((d 0 3 : ℤ) - (d 0 2 : ℤ)) := by
          rfl;
        exact h_d1_2.trans ( by erw [ show d 0 3 = 7 by exact nth_prime_vals.2.2.2.1, show d 0 2 = 5 by exact nth_prime_vals.2.2.1 ] ; decide );
      norm_num [ h_d2_1, h_d1_1, h_d1_2 ]
    have h_d2_2 : d 2 2 = 2 := by
      -- By definition of $d$, we know that $d^1(2) = 2$ and $d^1(3) = 4$.
      have h_d1_2 : d 1 2 = 2 := by
        -- By definition of $d$, we know that $d^1(2) = |p_3 - p_2|$.
        have h_d1_2 : d 1 2 = Int.natAbs ((Nat.nth Nat.Prime 3 : ℤ) - (Nat.nth Nat.Prime 2 : ℤ)) := by
          rfl;
        norm_num [ h_d1_2, nth_prime_vals ]
      have h_d1_3 : d 1 3 = 4 := by
        -- By definition of $d$, we know that $d^1(3) = |p_4 - p_3| = |11 - 7| = 4$.
        have h_d1_3 : d 1 3 = Int.natAbs ((Nat.nth Nat.Prime 4 : ℤ) - (Nat.nth Nat.Prime 3 : ℤ)) := by
          rfl
        norm_num [nth_prime_vals] at h_d1_3 ⊢
        exact h_d1_3;
      -- By definition of $d$, we know that $d^2(2) = |d^1(3) - d^1(2)|$.
      have h_d2_2 : d 2 2 = Int.natAbs ((d 1 3 : ℤ) - (d 1 2 : ℤ)) := by
        rfl
      rw [h_d2_2, h_d1_3, h_d1_2];
      decide
    -- By definition of $d$, we know that $d^3(1) = |d^2(2) - d^2(1)|$.
    have h_d3_1 : d 3 1 = Int.natAbs ((d 2 2 : ℤ) - (d 2 1 : ℤ)) := by
      rfl
    -- Substitute the values of $d^2(1)$ and $d^2(2)$ into the expression for $d^3(1)$.
    rw [h_d3_1, h_d2_1, h_d2_2]
    norm_num;
  norm_num [ h_d4_0, h_d3_0, h_d3_1 ]

/-
Helper lemma: The 6th prime number is 13.
-/
lemma nth_prime_val_5 : Nat.nth Nat.Prime 5 = 13 := by
  -- We'll use the fact that the first five primes are 2, 3, 5, 7, and 11.
  have h_primes : Nat.nth Nat.Prime 0 = 2 ∧ Nat.nth Nat.Prime 1 = 3 ∧ Nat.nth Nat.Prime 2 = 5 ∧ Nat.nth Nat.Prime 3 = 7 ∧ Nat.nth Nat.Prime 4 = 11 := by
    exact?;
  rw [ Nat.nth_eq_sInf ];
  exact le_antisymm ( Nat.sInf_le ⟨ by norm_num, fun k hk => by interval_cases k <;> norm_num [ h_primes ] ⟩ ) <| le_csInf ⟨ 13, by norm_num, fun k hk => by interval_cases k <;> norm_num [ h_primes ] ⟩ <| by rintro x ⟨ hx₁, hx₂ ⟩ ; exact le_of_not_gt fun hx₃ => by have := hx₂ 4 ( by norm_num ) ; interval_cases x <;> simp_all +decide only ;

/-
Verification of Gilbreath's conjecture for k=5.
-/
theorem gilbreath_5 : d 5 0 = 1 := by
  -- We'll use that $d^4(0) = 1$ to show that the first element of the sequence is 1 after five iterations.
  simp_all +decide [ d ];
  rw [ show Nat.nth Nat.Prime 5 = 13 by exact? ] ; norm_num

/-
Helper lemma: The 7th prime number is 17.
-/
lemma nth_prime_val_6 : Nat.nth Nat.Prime 6 = 17 := by
  -- We'll use the fact that the first six primes are 2, 3, 5, 7, 11, and 13.
  have h_prime_list : Nat.nth Nat.Prime 0 = 2 ∧ Nat.nth Nat.Prime 1 = 3 ∧ Nat.nth Nat.Prime 2 = 5 ∧ Nat.nth Nat.Prime 3 = 7 ∧ Nat.nth Nat.Prime 4 = 11 ∧ Nat.nth Nat.Prime 5 = 13 := by
    exact ⟨ by exact? , by exact? , by exact? , by exact? , by exact? , by exact? ⟩;
  rw [ Nat.nth_eq_sInf ];
  refine' le_antisymm _ _;
  · exact Nat.sInf_le ⟨ by norm_num, fun k hk => by interval_cases k <;> norm_num [ h_prime_list ] ⟩;
  · exact le_csInf ⟨ 17, by norm_num, fun k hk => by interval_cases k <;> norm_num [ * ] ⟩ fun x hx => not_lt.1 fun contra => by have := hx.2 5 ( by norm_num ) ; interval_cases x <;> simp_all +decide ;

/-
Verification of Gilbreath's conjecture for k=6.
-/
theorem gilbreath_6 : d 6 0 = 1 := by
  -- Let's calculate the value of $d_6(0)$ using the definitions and properties of the sequence.
  simp [d];
  -- We'll use that $p_6 = 17$ and $p_5 = 13$.
  have h_prime_6 : Nat.nth Nat.Prime 6 = 17 := by
    exact?
  have h_prime_5 : Nat.nth Nat.Prime 5 = 13 := by
    exact?
  rw [h_prime_6, h_prime_5]
  norm_num

/-
Helper lemma: The 8th prime number is 19.
-/
lemma nth_prime_val_7 : Nat.nth Nat.Prime 7 = 19 := by
  -- We'll use the fact that $p_7 = 19$.
  have hp7 : Nat.nth Nat.Prime 7 = 19 := by
    have : Nat.nth Nat.Prime 7 = Nat.nth Nat.Prime (Nat.count Nat.Prime 19) := by
      congr
    exact this.trans ( Nat.nth_count <| by norm_num );
  exact hp7

/-
Verification of Gilbreath's conjecture for k=7.
-/
theorem gilbreath_7 : d 7 0 = 1 := by
  -- By definition of $d$, we know that $d^0(n)$ is the $n$-th prime number.
  have h_prime_seq : d 0 0 = 2 ∧ d 0 1 = 3 ∧ d 0 2 = 5 ∧ d 0 3 = 7 ∧ d 0 4 = 11 ∧ d 0 5 = 13 ∧ d 0 6 = 17 ∧ d 0 7 = 19 := by
    have h_prime_seq : ∀ n, d 0 n = Nat.nth Nat.Prime n := by
      exact?;
    norm_num [ h_prime_seq, nth_prime_vals, nth_prime_val_5, nth_prime_val_6, nth_prime_val_7 ];
  -- By definition of $d$, we know that $d^k(n)$ is the absolute difference of $d^{k-1}(n+1)$ and $d^{k-1}(n)$.
  have h_diff : ∀ k n, d (k + 1) n = Int.natAbs ((d k (n + 1)) - (d k n)) := by
    exact?;
  simp +arith +decide [ * ]

/-
Helper lemma: The 9th prime number is 23.
-/
lemma nth_prime_val_8 : Nat.nth Nat.Prime 8 = 23 := by
  -- We'll use the fact that the 8th prime is 23.
  have h_prime8 : Nat.nth Nat.Prime 8 = 23 := by
    have : Nat.count Nat.Prime 23 = 8 := by
      native_decide
    rw [ ← this, Nat.nth_count ] ; norm_num;
  exact h_prime8

/-
Verification of Gilbreath's conjecture for k=8.
-/
theorem gilbreath_8 : d 8 0 = 1 := by
  -- By definition of $d$, we know that $d^0(n)$ is the $n$-th prime number.
  have h_prime_seq : d 0 0 = 2 ∧ d 0 1 = 3 ∧ d 0 2 = 5 ∧ d 0 3 = 7 ∧ d 0 4 = 11 ∧ d 0 5 = 13 ∧ d 0 6 = 17 ∧ d 0 7 = 19 ∧ d 0 8 = 23 := by
    -- By definition of $d$, we know that $d^0(n)$ is the $n$-th prime number. We can use the provided lemma `nth_prime_vals` to get the values for $n = 0, 1, 2, 3, 4, 5, 6, 7, 8$.
    have h_prime_seq : ∀ n ≤ 8, d 0 n = Nat.nth Nat.Prime n := by
      exact?
    generalize_proofs at *; (
    norm_num [ h_prime_seq, nth_prime_vals, nth_prime_val_5, nth_prime_val_6, nth_prime_val_7, nth_prime_val_8 ] at * <;> first | linarith | aesop | assumption;);
  -- By definition of $d$, we know that $d^k(n) = |d^{k-1}(n+1) - d^{k-1}(n)|$ for all $k \geq 1$.
  have h_recurrence : ∀ k n, d (k + 1) n = Int.natAbs ((d k (n + 1) : Int) - (d k n : Int)) := by
    exact?;
  norm_num [ h_prime_seq, h_recurrence ]

/-
Helper lemma: The 10th prime number is 29.
-/
lemma nth_prime_val_9 : Nat.nth Nat.Prime 9 = 29 := by
  -- We'll use the fact that $p_9 = 29$.
  have hp9 : Nat.nth Nat.Prime 9 = 29 := by
    have : Nat.count (Nat.Prime) 29 = 9 := by
      native_decide
    rw [ ← this, Nat.nth_count ];
    norm_num;
  exact hp9

/-
Verification of Gilbreath's conjecture for k=9.
-/
theorem gilbreath_9 : d 9 0 = 1 := by
  -- By definition of $d$, we know that $d^k(n) = |d^{k-1}(n+1) - d^{k-1}(n)|$.
  have hd : ∀ k n, d (k + 1) n = Int.natAbs ((d k (n + 1) : ℤ) - (d k n : ℤ)) := by
    exact?;
  -- By definition of $d$, we know that $d^0(n) = p_n$, where $p_n$ is the $n$-th prime number. Therefore, we can compute $d^0(n)$ for $n = 0, 1, 2, \ldots, 9$.
  have hd0_values : d 0 0 = 2 ∧ d 0 1 = 3 ∧ d 0 2 = 5 ∧ d 0 3 = 7 ∧ d 0 4 = 11 ∧ d 0 5 = 13 ∧ d 0 6 = 17 ∧ d 0 7 = 19 ∧ d 0 8 = 23 ∧ d 0 9 = 29 := by
    exact ⟨ nth_prime_vals.1, nth_prime_vals.2.1, nth_prime_vals.2.2.1, nth_prime_vals.2.2.2.1, nth_prime_vals.2.2.2.2, nth_prime_val_5, nth_prime_val_6, nth_prime_val_7, nth_prime_val_8, nth_prime_val_9 ⟩;
  norm_num [ hd0_values, hd ]

/-
Helper lemma: The 11th prime number is 31.
-/
lemma nth_prime_val_10 : Nat.nth Nat.Prime 10 = 31 := by
  -- We'll use the fact that $p_{11} = 31$ to show that $d^{10}(0) = 1$.
  have h_prime_11 : Nat.nth Nat.Prime 10 = 31 := by
    have : Nat.count Nat.Prime 31 = 10 := by
      native_decide
    rw [ ← this, Nat.nth_count ];
    norm_num;
  exact h_prime_11

/-
Verification of Gilbreath's conjecture for k=10.
-/
theorem gilbreath_10 : d 10 0 = 1 := by
  -- By definition of $d$, we know that $d^k(n) = |d^{k-1}(n+1) - d^{k-1}(n)|$.
  have hd : ∀ k n, d (k + 1) n = Int.natAbs ((d k (n + 1) : ℤ) - (d k n : ℤ)) := by
    exact?;
  -- By definition of $d$, we know that $d^0(n) = p_n$, where $p_n$ is the $n$-th prime number.
  have hd0 : ∀ n, d 0 n = Nat.nth Nat.Prime n := by
    exact?
  simp_all +decide [ Nat.Prime ];
  norm_num [ nth_prime_val_5, nth_prime_val_6, nth_prime_val_7, nth_prime_val_8, nth_prime_val_9, nth_prime_val_10 ] at *