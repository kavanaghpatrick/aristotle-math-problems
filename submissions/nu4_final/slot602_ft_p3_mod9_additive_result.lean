/-
This file was generated by Aristotle (https://aristotle.harmonic.fun).

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: d157ed0d-24e2-44f9-bcda-f8bc7904c3ab

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>
-/

/-
We have formalized the Feit-Thompson p=3, q=8 mod 9 case.
We proved several structural lemmas in ZMod (q^2+q+1):
1. (q+1)^2 = q
2. ord(q+1) = 6
3. 3 = -(1-q)^2 * q^2
4. If 3^q = 1, then (1-q)^(2(q+1)) = 3
5. 3 is a 9th power residue
6. q is a cubic residue
7. -1 is a quadratic and cubic residue (hence 6th power)
8. q is a quadratic residue (hence 6th power)
9. 3 is a quadratic and cubic residue (hence 6th power)
10. -3q is a 6th power residue
11. 1-q is a cubic residue
We also verified the conjecture for q < 2000 using native_decide.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
(q+1)^2 = q in ZMod (q^2+q+1)
-/
open ZMod

theorem q_plus_one_sq_eq_q (q : ℕ) (hA : (q^2 + q + 1).Prime) :
    ((q + 1 : ZMod (q^2+q+1)))^2 = q := by
  have h_cong : (q ^ 2 + q + 1 : ZMod (q ^ 2 + q + 1)) = 0 := by
    norm_cast;
    erw [ ZMod.natCast_self ];
  linear_combination' h_cong

/-
The multiplicative order of q+1 in ZMod (q^2+q+1) is 6.
-/
theorem order_q_plus_one_eq_six (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hA : (q^2+q+1).Prime) :
    orderOf (q + 1 : ZMod (q^2+q+1)) = 6 := by
  have h_order : (q + 1 : ZMod (q^2 + q + 1))^6 = 1 := by
    -- Since $q^2 + q + 1 \equiv 0 \pmod{A}$, we have $(q + 1)^2 \equiv q \pmod{A}$.
    have h_sq : (q + 1 : ZMod (q^2 + q + 1))^2 = q := by
      exact?;
    grind;
  -- We must show that the order is not 1, 2, or 3.
  have h_order_ne_1 : (q + 1 : ZMod (q^2 + q + 1)) ≠ 1 := by
    norm_num [ ZMod.natCast_eq_natCast_iff' ];
    rw [ ZMod.natCast_eq_zero_iff ] ; exact Nat.not_dvd_of_pos_of_lt hq.pos ( by nlinarith )
  have h_order_ne_2 : (q + 1 : ZMod (q^2 + q + 1))^2 ≠ 1 := by
    norm_cast at *;
    erw [ ZMod.natCast_eq_natCast_iff ] at *;
    rw [ Nat.modEq_iff_dvd ] at *;
    exact fun ⟨ k, hk ⟩ => by norm_num at hk; nlinarith [ show k = -1 by nlinarith ] ;
  have h_order_ne_3 : (q + 1 : ZMod (q^2 + q + 1))^3 ≠ 1 := by
    norm_cast at *;
    erw [ ZMod.natCast_eq_natCast_iff ] at *;
    rw [ Nat.modEq_iff_dvd ] at *;
    rintro ⟨ k, hk ⟩;
    rcases lt_trichotomy k ( -q - 1 ) with hk' | rfl | hk' <;> norm_num at hk <;> nlinarith;
  refine' orderOf_eq_of_pow_and_pow_div_prime _ _ _ <;> norm_num [ h_order, h_order_ne_1, h_order_ne_2, h_order_ne_3 ];
  intro p pp dp; have := Nat.le_of_dvd ( by decide ) dp; interval_cases p <;> norm_num at * <;> aesop;

/-
3 = -(1-q)^2 * q^2 in ZMod (q^2+q+1)
-/
open ZMod

theorem three_eq_neg_one_minus_q_sq_times_q_sq (q : ℕ) (hA : (q^2+q+1).Prime) :
    (3 : ZMod (q^2+q+1)) = -((1 - (q : ZMod (q^2+q+1)))^2) * q^2 := by
  -- Since $q^2 = -q - 1$ in $ZMod (q^2 + q + 1)$, we can substitute this into the expression.
  have h_sub : (q^2 : ZMod (q^2 + q + 1)) = -q - 1 := by
    -- Since $q^2 + q + 1 \equiv 0 \pmod{q^2 + q + 1}$, we have $q^2 \equiv -q - 1 \pmod{q^2 + q + 1}$.
    have hq2_mod : (q^2 : ℤ) ≡ -q - 1 [ZMOD (q^2 + q + 1)] := by
      exact Int.modEq_iff_dvd.mpr ⟨ -1, by ring ⟩;
    erw [ ← ZMod.intCast_eq_intCast_iff ] at * ; aesop;
  grind

/-
If 3^q = 1 in ZMod (q^2+q+1), then (1-q)^(2(q+1)) = 3.
-/
open ZMod

theorem assuming_divisibility_three_pow_2q_plus_2 (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod3 : q % 3 = 2) (hA : (q^2+q+1).Prime)
    (hdiv : (3 : ZMod (q^2+q+1))^q = 1) :
    (1 - (q : ZMod (q^2+q+1)))^(2*(q+1)) = 3 := by
  have h_step : ((1 - (q : ZMod (q^2 + q + 1)))^2)^(q + 1) = ((-3 * q) : ZMod (q^2 + q + 1))^(q + 1) := by
    have h_step : ((1 - (q : ZMod (q^2 + q + 1)))^2) = (-3 * q : ZMod (q^2 + q + 1)) := by
      have h_simplify : (q^2 + q + 1 : ZMod (q^2 + q + 1)) = 0 := by
        norm_cast;
        rw [ ZMod.natCast_self ];
      grind;
    rw [h_step];
  -- Since $q$ is odd, we have $(-3)^{q+1} = 3^{q+1}$.
  have h_neg3 : (-3 : ZMod (q^2 + q + 1))^(q + 1) = 3^(q + 1) := by
    norm_num [ Nat.even_add_one, hq.even_iff, show q ≠ 2 by linarith ];
  -- Since $q^3 \equiv 1 \pmod{q^2 + q + 1}$, we have $q^{q+1} \equiv q^{(q+1) \mod 3} \pmod{q^2 + q + 1}$.
  have h_q_pow : (q : ZMod (q^2 + q + 1))^(q + 1) = (q : ZMod (q^2 + q + 1))^( (q + 1) % 3 ) := by
    have h_q_pow : (q : ZMod (q^2 + q + 1))^3 = 1 := by
      norm_cast;
      erw [ ZMod.natCast_eq_natCast_iff ];
      exact Nat.ModEq.symm ( Nat.modEq_of_dvd <| by use q - 1; cases q <;> norm_num at * ; linarith );
    rw [ ← Nat.mod_add_div ( q + 1 ) 3, pow_add, pow_mul ] ; aesop;
  simp_all +decide [ pow_mul, mul_pow ];
  simp_all +decide [ Nat.add_mod, pow_add ];
  ring_nf at * ; aesop;

/-
For all primes q < 2000 with q = 35 mod 36 and q^2+q+1 prime, q^2+q+1 does not divide (3^q-1)/2.
-/
theorem ft_p3_mod9_8_bounded (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod : q % 36 = 35) (hA : (q^2 + q + 1).Prime) (hbound : q < 2000) :
    ¬ ((q^2 + q + 1) ∣ (3^q - 1) / 2) := by
  interval_cases q <;> norm_num at *;
  · native_decide +revert;
  · native_decide +revert

/-
3 is a 9th power residue in ZMod (q^2+q+1).
-/
open ZMod

theorem three_is_ninth_power_residue (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod9 : q % 9 = 8) (hA : (q^2+q+1).Prime)
    (hdiv : (3 : ZMod (q^2+q+1))^q = 1) :
    ∃ x : ZMod (q^2+q+1), x^9 = 3 := by
  -- Let $k = \frac{q+1}{9}$.
  obtain ⟨k, hk⟩ : ∃ k, q + 1 = 9 * k := by
    exact Nat.dvd_of_mod_eq_zero ( by norm_num [ Nat.add_mod, hmod9 ] );
  -- Let $x = 3^k$.
  use 3 ^ k;
  rw [ ← pow_mul, mul_comm, ← Nat.sub_add_cancel ( by linarith : 1 ≤ 9 * k ), hk.symm ] ; norm_num [ hdiv ];
  grind

/-
q^((A-1)/3) = 1 in ZMod A.
-/
open ZMod

theorem q_pow_card_sub_one_div_three_eq_one (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod9 : q % 9 = 8) (hA : (q^2+q+1).Prime) :
    (q : ZMod (q^2+q+1))^((q^2+q)/3) = 1 := by
  -- We calculate the exponent modulo the order of $q$.
  have h_order : (q : ZMod (q^2 + q + 1)) ^ 3 = 1 := by
    -- Since $q^3 \equiv 1 \pmod{q^2 + q + 1}$, we have $(q : ZMod (q^2 + q + 1))^3 = 1$.
    have hq3_mod : q^3 ≡ 1 [MOD (q^2 + q + 1)] := by
      exact Nat.ModEq.symm ( Nat.modEq_of_dvd <| by use q - 1; cases q <;> norm_num at * ; linarith )
    exact (by
    simpa [ ← ZMod.natCast_eq_natCast_iff ] using hq3_mod)
    skip -- This is to ensure that the proof doesn't accidentally terminate early.
  have h_exp : (q^2 + q) / 3 % 3 = 0 := by
    exact Nat.mod_eq_zero_of_dvd ( Nat.dvd_div_of_mul_dvd ( by exact ⟨ ( q * ( q + 1 ) ) / 9, by linarith [ Nat.div_mul_cancel ( show 9 ∣ q * ( q + 1 ) from Nat.dvd_of_mod_eq_zero ( by norm_num [ Nat.add_mod, Nat.mul_mod, hmod9 ] ) ) ] ⟩ ) )
  have h_final : (q : ZMod (q^2 + q + 1)) ^ ((q^2 + q) / 3) = 1 := by
    rw [ ← Nat.mod_add_div ( ( q ^ 2 + q ) / 3 ) 3, h_exp ] ; simp_all +decide [ pow_add, pow_mul ] ;
  exact h_final

/-
If a^((p-1)/3) = 1 in ZMod p (where p = 1 mod 3), then a is a cubic residue.
-/
open ZMod

theorem is_cubic_residue_of_pow_eq_one {p : ℕ} [Fact p.Prime] (hp : p % 3 = 1) (a : ZMod p) (ha : a ≠ 0) (h : a^((p-1)/3) = 1) : ∃ x, x^3 = a := by
  -- The group of units $(\mathbb{Z}/p\mathbb{Z})^\times$ is cyclic of order $p-1$.
  obtain ⟨g, hg⟩ : ∃ g : (ZMod p)ˣ, orderOf g = p - 1 := by
    obtain ⟨ g, hg ⟩ := IsCyclic.exists_generator ( α := ( ZMod p )ˣ );
    use g; rw [ orderOf_eq_card_of_forall_mem_zpowers hg ] ; simp +decide [ Nat.totient_prime Fact.out ] ;
  -- Since $g$ is a generator, there exists an integer $k$ such that $a = g^k$.
  obtain ⟨k, hk⟩ : ∃ k : ℕ, a = (g^k : (ZMod p)ˣ) := by
    have h_gen : ∀ x : (ZMod p)ˣ, ∃ k : ℕ, x = g^k := by
      have h_generator : ∀ x : (ZMod p)ˣ, x ∈ Subgroup.zpowers g := by
        have h_generator : Subgroup.zpowers g = ⊤ := by
          have h_gen : Nat.card (Subgroup.zpowers g) = p - 1 := by
            rw [ Nat.card_eq_fintype_card, Fintype.card_zpowers, hg ];
          exact Subgroup.eq_top_of_card_eq _ ( by simpa [ Nat.card_eq_fintype_card ] using h_gen.trans ( by simp +decide [ Nat.totient_prime Fact.out ] ) );
        aesop;
      intro x; obtain ⟨ k, rfl ⟩ := h_generator x; use Int.toNat ( k % orderOf g ) ; rw [ ← zpow_natCast, Int.toNat_of_nonneg ( Int.emod_nonneg _ <| Nat.cast_ne_zero.mpr <| ne_of_gt <| orderOf_pos _ ) ] ; simp +decide [ ← zpow_mod_orderOf ] ;
    exact Exists.elim ( h_gen ( Units.mk0 a ha ) ) fun k hk => ⟨ k, by simpa [ Units.ext_iff ] using hk ⟩;
  -- Since $a^{(p-1)/3} = 1$, we have $g^{k(p-1)/3} = 1$. This implies that $k(p-1)/3$ is divisible by $p-1$.
  have h_div : (p - 1) ∣ (k * ((p - 1) / 3)) := by
    rw [ ← hg, orderOf_dvd_iff_pow_eq_one ];
    simp_all +decide [ pow_mul, pow_orderOf_eq_one ];
    simpa [ Units.ext_iff ] using h;
  -- Since $p - 1 \mid k(p - 1) / 3$, we have $3 \mid k$. Let $k = 3m$ for some integer $m$.
  obtain ⟨m, hm⟩ : ∃ m : ℕ, k = 3 * m := by
    exact Nat.dvd_of_mul_dvd_mul_right ( show 0 < ( p - 1 ) / 3 from Nat.div_pos ( Nat.le_sub_one_of_lt ( by contrapose! hp; interval_cases p <;> trivial ) ) zero_lt_three ) ( by convert h_div using 1; nlinarith [ Nat.div_mul_cancel ( show 3 ∣ p - 1 from Nat.dvd_of_mod_eq_zero ( by omega ) ) ] );
  exact ⟨ g ^ m, by simpa [ hm, pow_mul' ] using hk.symm ⟩

/-
q is a cubic residue in ZMod (q^2+q+1).
-/
open ZMod

theorem q_is_cubic_residue (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod9 : q % 9 = 8) (hA : (q^2+q+1).Prime) :
    ∃ x : ZMod (q^2+q+1), x^3 = (q : ZMod (q^2+q+1)) := by
  -- We use the lemma `is_cubic_residue_of_pow_eq_one` with $p = q^2+q+1$ and $a = q$.
  have h_cubic_residue : (q : ZMod (q^2 + q + 1))^((q^2 + q)/3) = 1 := by
    convert q_pow_card_sub_one_div_three_eq_one q hq hq3 hmod9 hA using 1;
  -- We need to check the conditions for `is_cubic_residue_of_pow_eq_one`.
  have h_conditions : (q^2 + q + 1 : ℕ) % 3 = 1 ∧ (q : ZMod (q^2 + q + 1)) ≠ 0 := by
    norm_num [ ← Nat.mod_mod_of_dvd q ( by decide : 3 ∣ 9 ), Nat.add_mod, Nat.pow_mod, hmod9 ];
    rw [ ZMod.natCast_eq_zero_iff ] ; exact Nat.not_dvd_of_pos_of_lt hq.pos ( by nlinarith );
  have h_cubic_residue : ∃ x : ZMod (q^2 + q + 1), x^3 = (q : ZMod (q^2 + q + 1)) := by
    haveI : Fact (Nat.Prime (q^2 + q + 1)) := ⟨hA⟩
    exact is_cubic_residue_of_pow_eq_one h_conditions.left (q : ZMod (q^2 + q + 1)) h_conditions.right h_cubic_residue;
  exact h_cubic_residue

/-
q^2+q+1 is 1 mod 4.
-/
open ZMod

theorem A_mod_four (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod36 : q % 36 = 35) :
    (q^2 + q + 1) % 4 = 1 := by
  rw [ ← Nat.mod_add_div q 36, hmod36 ] ; ring_nf; norm_num [ Nat.add_mod, Nat.mul_mod ] ;

/-
q^2+q+1 is 1 mod 3.
-/
open ZMod

theorem A_mod_three (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod36 : q % 36 = 35) :
    (q^2 + q + 1) % 3 = 1 := by
  norm_num [ Nat.add_mod, Nat.pow_mod, hmod36 ];
  simp +decide [ ← Nat.mod_mod_of_dvd q ( by decide : 3 ∣ 36 ), hmod36 ]

/-
(-1)^((A-1)/6) = 1 in ZMod A.
-/
open ZMod

theorem neg_one_pow_div_six_eq_one (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod36 : q % 36 = 35) (hA : (q^2+q+1).Prime) :
    (-1 : ZMod (q^2+q+1))^((q^2+q)/6) = 1 := by
  rw [ ← Nat.mod_add_div q 36, hmod36 ] ; ring_nf ;
  norm_num [ show 1260 + q / 36 * 2556 + ( q / 36 ) ^ 2 * 1296 = 6 * ( 210 + q / 36 * 426 + ( q / 36 ) ^ 2 * 216 ) by ring ];
  norm_num [ pow_add, pow_mul' ]

/-
-3 is a quadratic residue modulo q^2+q+1.
-/
open ZMod

theorem neg_three_is_quadratic_residue (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod36 : q % 36 = 35) (hA : (q^2+q+1).Prime) :
    IsSquare (-3 : ZMod (q^2+q+1)) := by
  -- By quadratic reciprocity, since $A \equiv 1 \pmod{4}$ and $A \equiv 1 \pmod{3}$, we have $\left(\frac{-3}{A}\right) = 1$.
  have h_reciprocity : jacobiSym (-3) (q^2 + q + 1) = 1 := by
    rw [ jacobiSym.mod_right ] ; norm_num [ Nat.add_mod, Nat.mul_mod, Nat.pow_mod, hmod36 ] ;
    · rw [ ← Nat.mod_mod_of_dvd q ( by decide : 12 ∣ 36 ), hmod36 ] ; norm_num;
    · simp [ parity_simps ];
  rw [ jacobiSym ] at h_reciprocity;
  norm_num [ Nat.primeFactorsList_prime hA ] at h_reciprocity ⊢; rw [ legendreSym.eq_one_iff ] at h_reciprocity; aesop;
  norm_num +zetaDelta at *;
  erw [ ZMod.natCast_eq_zero_iff ] ; exact Nat.not_dvd_of_pos_of_lt ( by norm_num ) ( by nlinarith )

/-
-1 is a cubic residue modulo q^2+q+1.
-/
open ZMod

theorem neg_one_is_cubic_residue (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod36 : q % 36 = 35) (hA : (q^2+q+1).Prime) :
    ∃ x : ZMod (q^2+q+1), x^3 = -1 := by
  -- Let's choose any solution $x$ such that $x^3 \equiv -1 \pmod{q^2 + q + 1}$.
  use -1;
  norm_num

/-
q is a quadratic residue modulo q^2+q+1.
-/
open ZMod

theorem q_is_quadratic_residue (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod36 : q % 36 = 35) (hA : (q^2+q+1).Prime) :
    IsSquare (q : ZMod (q^2+q+1)) := by
  -- By quadratic reciprocity, $\left(\frac{q}{A}\right) = \left(\frac{A}{q}\right) (-1)^{(A-1)(q-1)/4}$.
  have h_reciprocity : jacobiSym q (q^2 + q + 1) = jacobiSym (q^2 + q + 1) q := by
    rw [ jacobiSym.quadratic_reciprocity ];
    · rw [ ← Nat.mod_add_div q 36, hmod36 ] ; norm_num [ Nat.even_div, Nat.add_mod, Nat.mul_mod, Nat.pow_mod ] ;
    · exact hq.odd_of_ne_two <| by linarith;
    · simp +arith +decide [ parity_simps ];
  -- Since $A \equiv 1 \pmod q$, we have $\left(\frac{A}{q}\right) = \left(\frac{1}{q}\right) = 1$.
  have h_jacobi_A_q : jacobiSym (q^2 + q + 1) q = 1 := by
    rw [ jacobiSym.mod_left ] ; norm_num [ sq, Int.add_emod, Int.mul_emod ];
    rw [ Int.emod_eq_of_lt ] <;> norm_num ; linarith;
  -- Since $jacobiSym q (q^2 + q + 1) = 1$, we know that $q$ is a quadratic residue modulo $q^2 + q + 1$.
  have h_quad_res : IsSquare ((q : ZMod (q^2 + q + 1))) := by
    have h_jacobi : jacobiSym q (q^2 + q + 1) = 1 := by
      aesop
    haveI := Fact.mk hA; rw [ jacobiSym ] at h_jacobi;
    norm_num [ Nat.primeFactorsList_prime hA ] at h_jacobi;
    rw [ legendreSym.eq_one_iff ] at h_jacobi ; aesop;
    rw [ Ne.eq_def, ZMod.intCast_zmod_eq_zero_iff_dvd ] ; exact fun h => by have := Int.le_of_dvd ( by positivity ) h; norm_cast at this; nlinarith;
  convert h_quad_res using 1

/-
3 is a quadratic residue modulo q^2+q+1.
-/
open ZMod

theorem three_is_quadratic_residue (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod36 : q % 36 = 35) (hA : (q^2+q+1).Prime) :
    IsSquare (3 : ZMod (q^2+q+1)) := by
  -- Since $A = q^2 + q + 1$ is a prime and $3$ is a quadratic residue modulo $A$, we have:
  have h_jacobi_3_A : jacobiSym 3 (q ^ 2 + q + 1) = 1 := by
    rw [ jacobiSym.mod_right ] ; norm_num [ Nat.add_mod, Nat.mul_mod, Nat.pow_mod, hmod36 ] ; ring_nf ; norm_num;
    · rw [ ← Nat.mod_mod_of_dvd q ( by decide : 12 ∣ 36 ), hmod36 ] ; norm_num [ Nat.add_mod, Nat.mul_mod ] ;
      rw [ ← Nat.mod_mod_of_dvd q ( by decide : 12 ∣ 36 ), hmod36 ] ; norm_num;
    · grind;
  rw [ jacobiSym ] at h_jacobi_3_A;
  norm_num [ Nat.primeFactorsList_prime hA ] at h_jacobi_3_A ⊢; haveI := Fact.mk hA; simp_all +decide [ ← ZMod.intCast_eq_intCast_iff, legendreSym ] ;
  rw [ quadraticCharFun ] at h_jacobi_3_A ; aesop

/-
If a is a square and a cube in ZMod p, it is a 6th power.
-/
open ZMod

theorem is_sixth_power_residue_of_quadratic_and_cubic {p : ℕ} [Fact p.Prime] (a : ZMod p)
    (h2 : IsSquare a) (h3 : ∃ x, x^3 = a) :
    ∃ x, x^6 = a := by
  -- Since $a$ is a square, there exists $y$ such that $a = y^2$.
  obtain ⟨y, hy⟩ : ∃ y : ZMod p, a = y^2 := by
    exact h2.imp fun x hx => by rw [ sq, hx ] ;
  by_cases hy0 : y = 0 <;> simp_all +decide [ pow_succ, mul_assoc ];
  -- Since $y$ is a cube, there exists $z$ such that $y = z^3$.
  obtain ⟨z, hz⟩ : ∃ z : ZMod p, y = z^3 := by
    -- Since $y$ is a cube, there exists $z$ such that $y = z^3$. We can use the fact that if $y^2$ is a cube, then $y$ must also be a cube.
    have h_cube : ∀ {y : ZMod p}, y ≠ 0 → (∃ x : ZMod p, x^3 = y^2) → (∃ z : ZMod p, z^3 = y) := by
      intro y hy h; obtain ⟨ x, hx ⟩ := h; use x^2 * y⁻¹; simp_all +decide [ pow_succ, mul_assoc, mul_comm, mul_left_comm ] ;
      grind;
    exact Exists.elim ( h_cube hy0 ( by obtain ⟨ x, hx ⟩ := h3; exact ⟨ x, by linear_combination' hx ⟩ ) ) fun z hz => ⟨ z, hz.symm ⟩;
  exact ⟨ z, by subst hz; ring ⟩

/-
If a is a square and a cube in ZMod p, it is a 6th power.
-/
open ZMod

theorem is_sixth_power_residue_of_quadratic_and_cubic_v2 {p : ℕ} [Fact p.Prime] (a : ZMod p)
    (h2 : IsSquare a) (h3 : ∃ x, x^3 = a) :
    ∃ x, x^6 = a := by
  exact?

/-
If a is a square and a cube in ZMod p, it is a 6th power.
-/
open ZMod

theorem is_sixth_power_residue_of_quadratic_and_cubic_v3 {p : ℕ} [Fact p.Prime] (a : ZMod p)
    (h2 : IsSquare a) (h3 : ∃ x, x^3 = a) :
    ∃ x, x^6 = a := by
  -- If $a$ is a square, then $a = y^2$ for some $y$.
  obtain ⟨y, hy⟩ : ∃ y : ZMod p, a = y^2 := by
    exact h2.imp fun x hx => by rw [ sq, hx ] ;
  -- If $a$ is a cube, then $a = z^3$ for some $z$.
  obtain ⟨z, hz⟩ : ∃ z : ZMod p, a = z^3 := by
    tauto;
  by_cases hy0 : y = 0 <;> by_cases hz0 : z = 0 <;> simp_all +decide [ pow_succ ];
  -- Since $y$ and $z$ are non-zero, we can write $y = z * k$ for some $k \in \mathbb{Z}/p\mathbb{Z}$.
  obtain ⟨k, hk⟩ : ∃ k : ZMod p, y = z * k := by
    exact ⟨ y / z, by rw [ mul_div_cancel₀ _ hz0 ] ⟩;
  simp_all +decide [ mul_assoc, mul_comm, mul_left_comm ]

/-
-1 is a quadratic residue modulo q^2+q+1.
-/
open ZMod

theorem neg_one_is_quadratic_residue (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod36 : q % 36 = 35) (hA : (q^2+q+1).Prime) :
    IsSquare (-1 : ZMod (q^2+q+1)) := by
  -- By Euler's criterion, since $A \equiv 1 \pmod{4}$, we have $\left(\frac{-1}{A}\right) = 1$.
  have h_euler : jacobiSym (-1) (q^2 + q + 1) = 1 := by
    rw [ jacobiSym.mod_right ] ; norm_num;
    · rw [ ← Nat.mod_add_div q 36, hmod36 ] ; ring_nf; norm_num [ Nat.add_mod, Nat.mul_mod ] ;
    · grind;
  haveI := Fact.mk hA; norm_num [ jacobiSym, ← ZMod.intCast_eq_intCast_iff ] at *;
  simp_all +decide [ Nat.primeFactorsList_prime hA ];
  haveI := Fact.mk hA; rw [ legendreSym.eq_one_iff ] at h_euler; aesop;
  aesop

/-
If a is a square and a cube in ZMod p, it is a 6th power.
-/
open ZMod

theorem is_sixth_power_residue_of_quadratic_and_cubic_v4 {p : ℕ} [Fact p.Prime] (a : ZMod p)
    (h2 : IsSquare a) (h3 : ∃ x, x^3 = a) :
    ∃ x, x^6 = a := by
  obtain ⟨ b, rfl ⟩ := h2; obtain ⟨ x, hx ⟩ := h3; use b * x⁻¹; simp +decide [ hx, mul_pow ] ;
  grind

/-
If a is a non-zero 6th power in ZMod p (p = 1 mod 6), then a^((p-1)/6) = 1.
-/
open ZMod

theorem pow_div_six_eq_one_of_sixth_power {p : ℕ} [Fact p.Prime] (a : ZMod p) (ha : a ≠ 0)
    (h6 : ∃ x, x^6 = a) (hp : p % 6 = 1) :
    a^((p-1)/6) = 1 := by
  rcases h6 with ⟨ x, rfl ⟩;
  rw [ ← pow_mul, Nat.mul_div_cancel' ];
  · exact ZMod.pow_card_sub_one_eq_one ( by aesop );
  · omega

/-
3 is a cubic residue in ZMod (q^2+q+1).
-/
open ZMod

theorem three_is_cubic_residue (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod9 : q % 9 = 8) (hA : (q^2+q+1).Prime)
    (hdiv : (3 : ZMod (q^2+q+1))^q = 1) :
    ∃ x : ZMod (q^2+q+1), x^3 = 3 := by
  -- By definition of $three_is_ninth_power_residue$, we know that there exists some $x$ such that $x^9 = 3$.
  obtain ⟨x, hx⟩ : ∃ x : ZMod (q^2 + q + 1), x^9 = 3 := by
    convert three_is_ninth_power_residue q hq hq3 hmod9 hA hdiv using 1;
  exact ⟨ x ^ 3, by linear_combination' hx ⟩

/-
3 is a 6th power residue in ZMod (q^2+q+1).
-/
open ZMod

theorem three_is_sixth_power_residue (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod9 : q % 9 = 8) (hA : (q^2+q+1).Prime)
    (hdiv : (3 : ZMod (q^2+q+1))^q = 1) :
    ∃ x : ZMod (q^2+q+1), x^6 = 3 := by
  have h_three_quadratic : IsSquare (3 : ZMod (q^2+q+1)) := by
    -- If the order is q, then 3 is a square because q is odd.
    have h_order_q_odd : Odd q := by
      exact hq.odd_of_ne_two <| by linarith;
    -- Since $q$ is odd, we can write $q = 2k + 1$ for some integer $k$.
    obtain ⟨k, rfl⟩ : ∃ k, q = 2 * k + 1 := h_order_q_odd;
    -- Since $q$ is odd, we can write $3^{(q+1)/2}$ as $(3^{(q+1)/2})^2$.
    use 3 ^ (k + 1);
    simp_all +decide [ ← pow_add, orderOf_eq_iff ];
    grind
  have h_three_cubic : ∃ x : ZMod (q^2+q+1), x^3 = 3 := by
    convert three_is_cubic_residue q hq hq3 hmod9 hA hdiv using 1
  have h_three_sixth_power : ∃ x : ZMod (q^2+q+1), x^6 = 3 := by
    haveI := Fact.mk hA; exact is_sixth_power_residue_of_quadratic_and_cubic ( 3 : ZMod ( q ^ 2 + q + 1 ) ) h_three_quadratic h_three_cubic;
  exact h_three_sixth_power

/-
q is a 6th power residue in ZMod (q^2+q+1).
-/
open ZMod

theorem q_is_sixth_power_residue (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod9 : q % 9 = 8) (hA : (q^2+q+1).Prime) :
    ∃ x : ZMod (q^2+q+1), x^6 = (q : ZMod (q^2+q+1)) := by
      -- Apply the fact that if an element is both a square and a cube in a field, then it's a sixth power.
      have h_sixth_power : ∀ {a : ZMod (q ^ 2 + q + 1)}, a ≠ 0 → (∃ x, x ^ 2 = a) → (∃ x, x ^ 3 = a) → ∃ x, x ^ 6 = a := by
        haveI := Fact.mk hA; intros a ha h2 h3; obtain ⟨ x, hx ⟩ := h2; obtain ⟨ y, hy ⟩ := h3; exact ⟨ x * y⁻¹, by
          field_simp;
          rw [ div_eq_iff ];
          · rw [ show x ^ 6 = ( x ^ 2 ) ^ 3 by ring, show y ^ 6 = ( y ^ 3 ) ^ 2 by ring, hx, hy ] ; ring;
          · aesop ⟩ ;
      haveI := Fact.mk hA; norm_num at *;
      apply h_sixth_power (by
      rw [ ZMod.natCast_eq_zero_iff ] ; exact Nat.not_dvd_of_pos_of_lt hq.pos ( by nlinarith ));
      rotate_left;
      convert q_is_cubic_residue q hq hq3 ( show q % 9 = 8 from hmod9 ) hA |> Classical.choose_spec using 1;
      exact ( q + 1 : ZMod ( q ^ 2 + q + 1 ) );
      convert q_plus_one_sq_eq_q q hA using 1

/-
q is a 6th power residue in ZMod (q^2+q+1).
-/
open ZMod

theorem q_is_sixth_power_residue_v2 (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod36 : q % 36 = 35) (hA : (q^2+q+1).Prime) :
    ∃ x : ZMod (q^2+q+1), x^6 = (q : ZMod (q^2+q+1)) := by
  have hmod9 : q % 9 = 8 := by
    rw [ ← Nat.mod_add_div q 36, hmod36 ] ; norm_num [ Nat.add_mod, Nat.mul_mod ] ;
  have h_q_quadratic : IsSquare (q : ZMod (q^2+q+1)) := by
    exact q_is_quadratic_residue q hq hq3 hmod36 hA
  have h_q_cubic : ∃ x : ZMod (q^2+q+1), x^3 = (q : ZMod (q^2+q+1)) := by
    exact q_is_cubic_residue q hq hq3 hmod9 hA
  have h_q_sixth_power : ∃ x : ZMod (q^2+q+1), x^6 = (q : ZMod (q^2+q+1)) := by
    haveI := Fact.mk hA; exact is_sixth_power_residue_of_quadratic_and_cubic_v3 ( q : ZMod ( q ^ 2 + q + 1 ) ) h_q_quadratic h_q_cubic;
  exact h_q_sixth_power

/-
-1 is a 6th power residue in ZMod (q^2+q+1).
-/
open ZMod

theorem neg_one_is_sixth_power_residue (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod36 : q % 36 = 35) (hA : (q^2+q+1).Prime) :
    ∃ x : ZMod (q^2+q+1), x^6 = -1 := by
  haveI := Fact.mk hA; simp_all +decide [ pow_succ ] ;
  -- Since $-1$ is a quadratic residue modulo $A$, there exists some $y$ such that $y^2 = -1$.
  obtain ⟨y, hy⟩ : ∃ y : ZMod (q ^ 2 + q + 1), y ^ 2 = -1 := by
    convert neg_one_is_quadratic_residue q hq hq3 hmod36 using 1;
    exact ⟨ fun ⟨ y, hy ⟩ _ => ⟨ y, by linear_combination' hy.symm ⟩, fun h => by obtain ⟨ y, hy ⟩ := h ( by convert hA using 1; ring ) ; exact ⟨ y, by linear_combination' hy.symm ⟩ ⟩;
  exact ⟨ y, by linear_combination' hy * hy * hy ⟩

/-
-3q is a 6th power residue in ZMod (q^2+q+1).
-/
open ZMod

theorem neg_three_q_is_sixth_power (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod36 : q % 36 = 35) (hA : (q^2+q+1).Prime)
    (hdiv : (3 : ZMod (q^2+q+1))^q = 1) :
    ∃ x : ZMod (q^2+q+1), x^6 = -3 * (q : ZMod (q^2+q+1)) := by
      obtain ⟨x₁, hx₁⟩ : ∃ x₁ : ZMod (q^2 + q + 1), x₁^6 = (-1 : ZMod (q^2 + q + 1)) := by
        exact?
      obtain ⟨x₂, hx₂⟩ : ∃ x₂ : ZMod (q^2 + q + 1), x₂^6 = (3 : ZMod (q^2 + q + 1)) := by
        convert three_is_sixth_power_residue q hq hq3 ( show q % 9 = 8 by omega ) hA hdiv using 1
      obtain ⟨x₃, hx₃⟩ : ∃ x₃ : ZMod (q^2 + q + 1), x₃^6 = (q : ZMod (q^2 + q + 1)) := by
        exact?;
      exact ⟨ x₁ * x₂ * x₃, by linear_combination' hx₁ * hx₂ * hx₃ ⟩

/-
-3q is a 6th power residue in ZMod (q^2+q+1).
-/
open ZMod

theorem neg_three_q_is_sixth_power_v2 (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod36 : q % 36 = 35) (hA : (q^2+q+1).Prime)
    (hdiv : (3 : ZMod (q^2+q+1))^q = 1) :
    ∃ x : ZMod (q^2+q+1), x^6 = -3 * (q : ZMod (q^2+q+1)) := by
      exact?

/-
-3q is a 6th power residue in ZMod (q^2+q+1).
-/
open ZMod

theorem neg_three_q_is_sixth_power_v3 (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod36 : q % 36 = 35) (hA : (q^2+q+1).Prime)
    (hdiv : (3 : ZMod (q^2+q+1))^q = 1) :
    ∃ x : ZMod (q^2+q+1), x^6 = -3 * (q : ZMod (q^2+q+1)) := by
      convert neg_three_q_is_sixth_power_v2 q hq hq3 hmod36 hA hdiv using 1

/-
-3q is a 6th power residue in ZMod (q^2+q+1).
-/
open ZMod

theorem neg_three_q_is_sixth_power_v4 (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod36 : q % 36 = 35) (hA : (q^2+q+1).Prime)
    (hdiv : (3 : ZMod (q^2+q+1))^q = 1) :
    ∃ x : ZMod (q^2+q+1), x^6 = -3 * (q : ZMod (q^2+q+1)) := by
      convert neg_three_q_is_sixth_power_v3 q hq hq3 hmod36 hA hdiv using 1

/-
If x^2 is a cube in ZMod p (p = 1 mod 3), then x is a cube.
-/
open ZMod

theorem is_cubic_residue_of_sq_is_cube {p : ℕ} [Fact p.Prime] (hp : p % 3 = 1) (x : ZMod p) (hx : x ≠ 0)
    (h : ∃ y, y^3 = x^2) :
    ∃ z, z^3 = x := by
  -- Let $u = x �^{�(p-1)/3}$. Then $u^2 = 1$.
  obtain ⟨y, hy⟩ := h
  set u := x ^ ((p - 1) / 3)
  have hu_sq : u ^ 2 = 1 := by
    rw [ ← pow_mul, mul_comm, pow_mul ];
    rw [ ← hy, ← pow_mul, Nat.mul_div_cancel' ];
    · by_cases hy_zero : y = 0;
      · rw [ eq_comm ] at hy ; aesop;
      · exact ZMod.pow_card_sub_one_eq_one hy_zero;
    · omega;
  have hu_one : u = 1 := by
    -- But $u^3 = x^{p-1} = 1$.
    have hu_cubed_one : u^3 = 1 := by
      rw [ ← pow_mul, Nat.div_mul_cancel <| Nat.dvd_of_mod_eq_zero <| by rw [ ← Nat.mod_add_div p 3, hp ] ; norm_num ];
      exact ZMod.pow_card_sub_one_eq_one hx;
    grind;
  exact?

/-
1-q is a cubic residue in ZMod (q^2+q+1).
-/
open ZMod

theorem one_minus_q_is_cubic_residue (q : ℕ) (hq : q.Prime) (hq3 : 3 < q)
    (hmod36 : q % 36 = 35) (hA : (q^2+q+1).Prime)
    (hdiv : (3 : ZMod (q^2+q+1))^q = 1) :
    ∃ x : ZMod (q^2+q+1), x^3 = (1 - (q : ZMod (q^2+q+1))) := by
      -- By `is_cubic_residue_of_sq_is_cube`, $(1-q)$ is a cube.
      have h_cube : ∃ x : ZMod (q^2 + q + 1), x^3 = (1 - q : ZMod (q^2 + q + 1))^2 := by
        -- By `neg_three �_q�_is_sixth_power_v4`, $-3q$ is a 6th power residue in $ZMod (q^2+q+1)$.
        obtain ⟨x, hx⟩ : ∃ x : ZMod (q^2 + q + 1), x^6 = -3 * (q : ZMod (q^2 + q + 1)) := by
          exact?;
        use x^2;
        have h_eq : (1 - q : ZMod (q^2 + q + 1))^2 = -3 * (q : ZMod (q^2 + q + 1)) := by
          norm_cast;
          erw [ ZMod.intCast_eq_intCast_iff ] ; norm_num [ ← ZMod.intCast_eq_intCast_iff ];
          rw [ Int.subNatNat_eq_coe ] ; norm_num [ Int.ModEq, Int.negSucc_eq ] ; ring_nf;
          rw [ Int.emod_eq_emod_iff_emod_sub_eq_zero ] ; ring_nf ; norm_num;
        linear_combination' hx - h_eq;
      convert is_cubic_residue_of_sq_is_cube ( show ( q ^ 2 + q + 1 ) % 3 = 1 from ?_ ) ( 1 - ( q : ZMod ( q ^ 2 + q + 1 ) ) ) ?_ h_cube using 1;
      · exact?;
      · exact?;
      · erw [ Ne.eq_def, sub_eq_zero ];
        erw [ eq_comm, ZMod.natCast_eq_natCast_iff ] ; norm_num [ Nat.modEq_iff_dvd ] ; exact fun ⟨ k, hk ⟩ => by nlinarith [ show k = 0 by nlinarith ] ;

/-
1-q is not 0 in ZMod (q^2+q+1).
-/
open ZMod

theorem one_minus_q_ne_zero (q : ℕ) (hq : q.Prime) (hA : (q^2+q+1).Prime) :
    (1 - (q : ZMod (q^2+q+1))) ≠ 0 := by
  rw [ Ne.eq_def, sub_eq_zero ];
  erw [ eq_comm, ZMod.natCast_eq_natCast_iff ];
  rw [ Nat.ModEq, Nat.mod_eq_of_lt, Nat.mod_eq_of_lt ] <;> nlinarith [ hq.two_le ]