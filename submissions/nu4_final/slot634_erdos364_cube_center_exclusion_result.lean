/-
This file was generated by Aristotle (https://aristotle.harmonic.fun).

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 8d138551-1b24-46cb-88e3-c88820364ea8

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>

Aristotle's budget for this request has been reached.
If there is partial progress, it will appear in this file.
If you would like to continue working off of this partial progress,
please submit the same prompt, and add this .lean file in "Optional: Attach a Lean file as context" field.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

#check IsSquare

/-
A number is powerful (squarefull) if every prime factor appears with exponent ≥ 2.
A number is a perfect cube if it is the cube of some integer.
-/
def Powerful (n : ℕ) : Prop :=
  ∀ p : ℕ, p.Prime → p ∣ n → p ^ 2 ∣ n

def IsCube (n : ℕ) : Prop :=
  ∃ m : ℕ, m ^ 3 = n

/-
If the product of two coprime numbers is powerful, then each number is powerful.
-/
lemma powerful_of_coprime_mul_powerful {a b : ℕ} (h_coprime : Nat.Coprime a b) (h_pow : Powerful (a * b)) : Powerful a ∧ Powerful b := by
  refine ⟨ fun p pp dp => ?_, fun p pp dp => ?_ ⟩;
  · have := h_pow p pp ( dvd_mul_of_dvd_left dp _ );
    refine' Nat.Coprime.dvd_of_dvd_mul_right _ this;
    exact Nat.Coprime.pow_left 2 ( pp.coprime_iff_not_dvd.mpr fun h => by have := Nat.dvd_gcd dp h; aesop );
  · have := h_pow p pp ( dvd_mul_of_dvd_right dp _ );
    exact ( Nat.Coprime.dvd_of_dvd_mul_left ( show Nat.Coprime ( p ^ 2 ) a from Nat.Coprime.pow_left 2 <| pp.coprime_iff_not_dvd.mpr fun h => pp.not_dvd_one <| h_coprime.gcd_eq_one ▸ Nat.dvd_gcd h dp ) this )

/-
The gcd of m-1 and m^2+m+1 divides 3.
-/
lemma gcd_m_minus_1_m_sq_plus_m_plus_1 (m : ℕ) : Nat.gcd (m - 1) (m^2 + m + 1) ∣ 3 := by
  rcases m with ( _ | _ | m ) <;> simp_all +decide [ Nat.succ_eq_add_one ];
  norm_num [ ( by ring : ( m + 1 + 1 ) ^ 2 + ( m + 1 + 1 ) + 1 = ( m + 1 ) * ( m + 1 + 3 ) + 3 ) ];
  exact Nat.gcd_dvd_right _ _

/-
The gcd of m+1 and m^2-m+1 divides 3.
-/
lemma gcd_m_plus_1_m_sq_minus_m_plus_1 (m : ℕ) : Nat.gcd (m + 1) (m^2 - m + 1) ∣ 3 := by
  rw [ ← Int.natCast_dvd_natCast ] ; norm_num [ show m ^ 2 - m = m * ( m - 1 ) by rw [ Nat.pow_two, Nat.mul_sub_left_distrib, Nat.mul_one ] ];
  rcases m with ( _ | _ | m ) <;> norm_num at *;
  norm_num [ ( by ring : ( m + 1 + 1 ) * ( m + 1 ) + 1 = ( m + 1 + 1 + 1 ) * ( m ) + 3 ) ];
  exact_mod_cast Nat.gcd_dvd_right _ _

/-
If m is divisible by 3, then m-1 and m^2+m+1 are coprime.
-/
lemma coprime_m_minus_1_of_mod_3 (m : ℕ) (h : m % 3 = 0) : Nat.Coprime (m - 1) (m^2 + m + 1) := by
  rw [ ← Nat.mod_add_div m 3 ] ; norm_num [ h ];
  rcases k : m / 3 with ( _ | _ | k ) <;> simp_all +decide [ Nat.mul_succ, sq, Nat.coprime_mul_iff_left, Nat.coprime_mul_iff_right ];
  ring_nf at *;
  norm_num [ show 43 + ‹_› * 39 + ‹_› ^ 2 * 9 = ( 5 + ‹_› * 3 ) * ( 8 + ‹_› * 3 ) + 3 by ring ]

/-
If m is divisible by 3, then m+1 and m^2-m+1 are coprime.
-/
lemma coprime_m_plus_1_of_mod_3 (m : ℕ) (h : m % 3 = 0) : Nat.Coprime (m + 1) (m^2 - m + 1) := by
  -- Since $m \equiv 0 \pmod{3}$, we have $\gcd(m + 1, m^2 - m + 1) \mid 3$.
  have h_div : Nat.gcd (m + 1) (m^2 - m + 1) ∣ 3 := by
    exact?;
  simp_all +decide [ Nat.dvd_prime ];
  exact h_div.resolve_right fun h' => by have := Nat.gcd_dvd_left ( m + 1 ) ( m ^ 2 - m + 1 ) ; have := Nat.gcd_dvd_right ( m + 1 ) ( m ^ 2 - m + 1 ) ; simp_all +decide [ Nat.dvd_iff_mod_eq_zero, Nat.add_mod, Nat.pow_mod ] ;

/-
If n, n+1, n+2 are powerful, then n is odd.
-/
lemma odd_of_three_consecutive_powerful (n : ℕ) (h1 : Powerful n) (h2 : Powerful (n + 1)) (h3 : Powerful (n + 2)) : Odd n := by
  by_contra h_even;
  -- If $n$ is even, then $4 \mid n$.
  have h4_div_n : 4 ∣ n := by
    exact h1 2 Nat.prime_two ( even_iff_two_dvd.mp ( by simpa using h_even ) );
  -- Since $n$ is even, $n+2$ is also even. Therefore, $4 \mid n+2$.
  have h4_div_n2 : 4 ∣ n + 2 := by
    exact h3 2 Nat.prime_two ( even_iff_two_dvd.mp ( by simpa [ parity_simps ] using h_even ) );
  omega

/-
If n and n+2 are powerful and n+1=m^3, then m is even.
-/
lemma m_is_even (n m : ℕ) (h1 : Powerful n) (h3 : Powerful (n + 2)) (hm : n + 1 = m ^ 3) : Even m := by
  -- If m is odd, then m^3 is odd, so n is even. Since n is powerful, 4 | n.
  by_contra h_odd
  have h_even : Even n := by
    simpa [ h_odd, parity_simps ] using congr_arg Even hm
  have h_div4 : 4 ∣ n := by
    have := h1 2 Nat.prime_two; simp_all +decide [ ← even_iff_two_dvd, parity_simps ] ;
  obtain ⟨ k, hk ⟩ := h_div4; specialize h3 2 Nat.prime_two; simp_all +decide [ ← Nat.dvd_iff_mod_eq_zero, Nat.Prime.dvd_mul ] ;
  norm_num [ Nat.dvd_add_right ] at h3

/-
A number is ThreeTimesPowerful if it is divisible by 3, not divisible by 9, and n/3 is powerful.
-/
def ThreeTimesPowerful (n : ℕ) : Prop :=
  3 ∣ n ∧ ¬ (9 ∣ n) ∧ Powerful (n / 3)

/-
If m ≡ 1 (mod 3) and m^3+1 is powerful, then m^2-m+1 is powerful.
-/
lemma powerful_of_m_eq_1_mod_3_right (m : ℕ) (h_mod : m % 3 = 1) (h_pow : Powerful (m^3 + 1)) : Powerful (m^2 - m + 1) := by
  -- Since $m^3 + 1 = (m + 1)(m^2 - m + 1)$ and $m \equiv 1 \pmod{3}$, we know that $m + 1$ and $m^2 - m + 1$ are coprime.
  have h_coprime : Nat.Coprime (m + 1) (m ^ 2 - m + 1) := by
    norm_num [ show m ^ 2 - m = m * ( m - 1 ) by rw [ Nat.pow_two, Nat.mul_sub_left_distrib, Nat.mul_one ] ];
    rcases m with ( _ | _ | m ) <;> simp_all +decide [ Nat.succ_eq_add_one, mul_add ];
    norm_num [ ( by ring : ( m + 1 + 1 ) * m + ( m + 1 + 1 ) + 1 = ( m + 1 + 1 + 1 ) * ( m ) + 3 ) ];
    exact Nat.Coprime.symm ( Nat.prime_three.coprime_iff_not_dvd.mpr fun h => by omega );
  convert powerful_of_coprime_mul_powerful h_coprime _ |> And.right using 1;
  convert h_pow using 1 ; rw [ show m ^ 3 + 1 = ( m + 1 ) * ( m ^ 2 - m + 1 ) by nlinarith [ Nat.sub_add_cancel ( show m ^ 2 ≥ m by nlinarith ) ] ]

/-
If m ≡ 1 (mod 3) and m^3-1 is powerful, then m^2+m+1 is ThreeTimesPowerful.
-/
lemma three_times_powerful_of_m_eq_1_mod_3_left (m : ℕ) (h_mod : m % 3 = 1) (h_pow : Powerful (m^3 - 1)) : ThreeTimesPowerful (m^2 + m + 1) := by
  -- Let $A = m - 1$ and $B = m^2 + m + 1$.
  set A := m - 1
  set B := m^2 + m + 1
  have hAB : A * B = m^3 - 1 := by
    cases m <;> norm_num [ A, B ] ; ring;
    exact Eq.symm ( Nat.sub_eq_of_eq_add <| by ring )
  have hAB_pow : Powerful (A * B) := by
    aesop
  have h_coprime : Nat.gcd A B = 3 := by
    rcases m with ( _ | _ | m ) <;> simp_all +decide [ Nat.succ_eq_add_one ];
    · trivial;
    · simp +zetaDelta at *;
      norm_num [ ( by ring : ( m + 1 + 1 ) ^ 2 + ( m + 1 + 1 ) + 1 = ( m + 1 ) * ( m + 1 + 3 ) + 3 ) ];
      exact Nat.gcd_eq_right ( Nat.dvd_of_mod_eq_zero ( by omega ) )
  have h_div_3 : 3 ∣ B ∧ ¬ (9 ∣ B) := by
    simp +zetaDelta at *;
    exact ⟨ Nat.dvd_of_mod_eq_zero ( by norm_num [ Nat.add_mod, Nat.pow_mod, h_mod ] ), by rw [ Nat.dvd_iff_mod_eq_zero ] ; rw [ ← Nat.mod_add_div m 3, h_mod ] ; ring_nf; norm_num [ Nat.add_mod, Nat.mul_mod ] ⟩
  have hB_pow : Powerful (B / 3) := by
    -- Let $A = 3A'$ and $B = 3B'$.
    obtain ⟨A', hA'⟩ : ∃ A', A = 3 * A' := by
      exact h_coprime ▸ Nat.gcd_dvd_left _ _
    obtain ⟨B', hB'⟩ : ∃ B', B = 3 * B' := by
      exact h_div_3.1;
    -- Since $A'$ and $B'$ are coprime and $9A'B'$ is powerful, $B'$ must be powerful.
    have hB'_pow : Powerful (9 * A' * B') := by
      convert hAB_pow using 1 ; rw [ hA', hB' ] ; ring
    have hB'_pow' : Powerful (B') := by
      intro p pp dp; specialize hB'_pow p pp; simp_all +decide [ Nat.Prime.dvd_mul ] ;
      -- Since $p$ divides $B'$ and $p$ is prime, $p$ cannot divide $A'$ because $A'$ and $B'$ are coprime.
      have h_not_div_A' : ¬(p ∣ A') := by
        intro h; have := Nat.dvd_gcd ( dvd_mul_of_dvd_right h 3 ) ( dvd_mul_of_dvd_right dp 3 ) ; simp_all +decide ;
        have := Nat.le_of_dvd ( by decide ) this; interval_cases p <;> simp_all +decide [ ← even_iff_two_dvd, parity_simps ] ;
        exact h_div_3 ( dvd_trans ( by decide ) ( mul_dvd_mul_left 3 dp ) );
      -- Since $p$ divides $B'$ and $p$ is prime, $p$ cannot divide $9$ because $9 = 3^2$ and $p \neq 3$.
      have h_not_div_9 : ¬(p ∣ 9) := by
        intro h; have := Nat.le_of_dvd ( by decide ) h; interval_cases p <;> norm_num at *;
        exact h_div_3 ( dvd_trans ( by decide ) ( mul_dvd_mul_left 3 dp ) );
      exact ( Nat.Coprime.dvd_of_dvd_mul_left ( show Nat.Coprime ( p ^ 2 ) ( 9 * A' ) from by simpa [ Nat.coprime_comm ] using pp.coprime_iff_not_dvd.mpr h_not_div_9 |> Nat.Coprime.mul_right <| pp.coprime_iff_not_dvd.mpr h_not_div_A' ) hB'_pow )
    aesop
  exact ⟨by
  exact h_div_3.1, by
    exact h_div_3.2, hB_pow⟩

/-
If m ≡ 2 (mod 3) and m^3-1 is powerful, then m^2+m+1 is powerful.
-/
lemma powerful_of_m_eq_2_mod_3_left (m : ℕ) (h_mod : m % 3 = 2) (h_pow : Powerful (m^3 - 1)) : Powerful (m^2 + m + 1) := by
  -- Since $m \equiv 2 \pmod{3}$, we have $\gcd(m^2 + m + 1, m - 1) = 1$.
  have h_coprime : Nat.gcd (m^2 + m + 1) (m - 1) = 1 := by
    rcases m with ( _ | _ | m ) <;> simp_all +decide [ Nat.pow_succ' ];
    norm_num [ ( by ring : ( m + 1 + 1 ) * ( m + 1 + 1 ) + ( m + 1 + 1 ) + 1 = ( m + 1 ) * ( m + 1 + 1 + 1 + 1 ) + 3 ) ];
    exact Nat.prime_three.coprime_iff_not_dvd.mpr ( by omega );
  -- Since $m^3 - 1 = (m - 1)(m^2 + m + 1)$ and $m^3 - 1$ is powerful, it follows that $m^2 + m + 1$ is powerful.
  have h_factor : m^3 - 1 = (m - 1) * (m^2 + m + 1) := by
    exact Nat.sub_eq_of_eq_add <| by cases m <;> norm_num at * ; linarith;
  convert powerful_of_coprime_mul_powerful _ _ |>.2 using 1;
  exacts [ m - 1, Nat.Coprime.symm h_coprime, by simpa only [ h_factor ] using h_pow ]

/-
If m ≡ 2 (mod 3) and m^3+1 is powerful, then m^2-m+1 is ThreeTimesPowerful.
-/
lemma three_times_powerful_of_m_eq_2_mod_3_right (m : ℕ) (h_mod : m % 3 = 2) (h_pow : Powerful (m^3 + 1)) : ThreeTimesPowerful (m^2 - m + 1) := by
  -- Let $A = m + 1$ and $B = m^2 - m + 1$.
  set A := m + 1
  set B := m^2 - m + 1
  have hAB : A * B = m^3 + 1 := by
    simp +zetaDelta at *;
    nlinarith [ Nat.sub_add_cancel ( by nlinarith : m ≤ m^2 ) ]
  have hAB_pow : Powerful (A * B) := by
    aesop
  have h_coprime : Nat.gcd A B = 3 := by
    -- Since $m \equiv 2 \pmod{3}$, we have $m = 3k + 2$ for some integer $k$.
    obtain ⟨k, rfl⟩ : ∃ k, m = 3 * k + 2 := by
      exact ⟨ m / 3, by rw [ ← h_mod, Nat.div_add_mod ] ⟩;
    simp +zetaDelta at *;
    norm_num [ show ( 3 * k + 2 ) ^ 2 - ( 3 * k + 2 ) = ( 3 * k + 2 ) * ( 3 * k + 1 ) by rw [ Nat.sub_eq_of_eq_add ] ; ring ];
    norm_num [ ( by ring : ( 3 * k + 2 ) * ( 3 * k + 1 ) + 1 = ( 3 * k + 2 + 1 ) * ( 3 * k ) + 3 ) ];
    norm_num [ ( by ring : 3 * k + 2 + 1 = 3 * ( k + 1 ) ) ]
  have h_div_3 : 3 ∣ B ∧ ¬ (9 ∣ B) := by
    zify at *;
    simp +zetaDelta at *;
    rw [ Nat.cast_sub ( by nlinarith only [ h_mod ] ) ] ; norm_num [ Int.add_emod, Int.sub_emod, Int.mul_emod, sq, h_mod ] ;
    exact ⟨ Int.dvd_of_emod_eq_zero ( by norm_num [ Int.add_emod, Int.sub_emod, Int.mul_emod, h_mod ] ), by rw [ Int.dvd_iff_emod_eq_zero ] ; rw [ ← Int.emod_add_mul_ediv m 3, h_mod ] ; ring_nf; norm_num [ Int.add_emod, Int.sub_emod, Int.mul_emod ] ⟩
  have hB_pow : Powerful (B / 3) := by
    -- Let $A = 3A'$ and $B = 3B'$.
    obtain ⟨A', hA'⟩ : ∃ A', A = 3 * A' := by
      exact h_coprime ▸ Nat.gcd_dvd_left _ _ |> fun h => dvd_trans ( by norm_num ) h;
    obtain ⟨B', hB'⟩ : ∃ B', B = 3 * B' := by
      exact h_div_3.left
    have h_coprime' : Nat.gcd A' B' = 1 := by
      simp_all +decide [ Nat.gcd_mul_left ]
    have hAB'_pow : Powerful (9 * A' * B') := by
      convert hAB_pow using 1 ; rw [ hA', hB' ] ; ring
    have hB'_pow : Powerful B' := by
      have := powerful_of_coprime_mul_powerful ( show Nat.Coprime ( 9 * A' ) B' from ?_ ) hAB'_pow; aesop;
      simp_all +decide [ Nat.coprime_mul_iff_left, Nat.coprime_mul_iff_right ];
      exact ⟨ Nat.Coprime.pow_left 2 ( Nat.prime_three.coprime_iff_not_dvd.mpr fun h => h_div_3 <| mul_dvd_mul_left 3 h ), h_coprime' ⟩
    grind +ring
  exact ⟨by
  exact h_div_3.left, by
    exact h_div_3.2, hB_pow⟩

/-
If n, n+1, n+2 are powerful, then n ≡ 3 (mod 4).
-/
lemma n_mod_4_eq_3 (n : ℕ) (h1 : Powerful n) (h2 : Powerful (n + 1)) (h3 : Powerful (n + 2)) : n % 4 = 3 := by
  have h5 := h1 2 Nat.prime_two; ( have h6 := h2 2 Nat.prime_two; ( have h7 := h3 2 Nat.prime_two; norm_num at * ; omega; ) )

/-
If (3k+1)^3-1 is powerful, then 3k^2+3k+1 is powerful.
-/
lemma powerful_3k_sq_plus_3k_plus_1 (k : ℕ) (h_pow : Powerful ((3 * k + 1) ^ 3 - 1)) : Powerful (3 * k ^ 2 + 3 * k + 1) := by
  -- Since $9k$ and $3k^2 + 3k + 1$ are coprime and their product is powerful, each must be powerful.
  have h_coprime : Nat.Coprime (9 * k) (3 * k^2 + 3 * k + 1) := by
    norm_num [ show 3 * k ^ 2 + 3 * k + 1 = 3 * k * ( k + 1 ) + 1 by ring ];
    norm_num [ show 9 * k = 3 * k * 3 by ring, Nat.coprime_mul_iff_left, Nat.coprime_mul_iff_right ];
    norm_num [ Nat.add_mod, Nat.mul_mod, Nat.coprime_iff_gcd_eq_one, Nat.gcd_rec ];
  convert powerful_of_coprime_mul_powerful h_coprime _ |> And.right using 1;
  convert h_pow using 1 ; rw [ Nat.sub_eq_of_eq_add ] ; ring

/-
If m ≡ 1 (mod 3), then m=3k+1 where k is odd, powerful away from 3, and 3k^2+3k+1 is powerful.
-/
lemma k_properties (n m : ℕ) (h1 : Powerful n) (h2 : Powerful (n + 1)) (h3 : Powerful (n + 2)) (hm : n + 1 = m ^ 3) (h_mod : m % 3 = 1) :
  ∃ k : ℕ, m = 3 * k + 1 ∧ Odd k ∧ (∀ p : ℕ, p.Prime → p ≠ 3 → p ∣ k → p ^ 2 ∣ k) ∧ Powerful (3 * k ^ 2 + 3 * k + 1) := by
    -- Let $k$ be such that $m = 3k + 1$.
    obtain ⟨k, rfl⟩ : ∃ k, m = 3 * k + 1 := by
      exact ⟨ m / 3, by rw [ ← h_mod, Nat.div_add_mod ] ⟩;
    -- Since $m$ is even, $k$ must be odd.
    have hk_odd : Odd k := by
      -- Since $m$ is even, $3k+1$ is even, which implies that $k$ is odd.
      have h_even_m : Even (3 * k + 1) := by
        exact m_is_even n ( 3 * k + 1 ) h1 h3 hm
      exact Nat.odd_iff.mpr (by
      rw [ Nat.even_iff ] at h_even_m; omega;);
    refine' ⟨ k, rfl, hk_odd, _, _ ⟩;
    · intro p pp p3 dp; have := h1 p pp; simp_all +decide [ Nat.dvd_add_right, dvd_pow ] ;
      -- Since $p$ divides $k$, we have $p^2 \mid n$.
      have h_div_n : p^2 ∣ n := by
        exact this ( by rw [ show n = 9 * k * ( 3 * k ^ 2 + 3 * k + 1 ) by linarith ] ; exact dvd_mul_of_dvd_left ( dvd_mul_of_dvd_right dp _ ) _ );
      -- Since $p$ divides $k$, we have $p^2 \mid 9k(3k^2 + 3k + 1)$.
      have h_div_prod : p^2 ∣ 9 * k * (3 * k^2 + 3 * k + 1) := by
        convert h_div_n using 1 ; nlinarith;
      -- Since $p$ divides $k$, we have $p^2 \mid 9k$.
      have h_div_9k : p^2 ∣ 9 * k := by
        refine' Nat.Coprime.dvd_of_dvd_mul_right _ h_div_prod;
        norm_num [ show 3 * k ^ 2 + 3 * k + 1 = k * ( 3 * k + 3 ) + 1 by ring ];
        exact pp.coprime_iff_not_dvd.mpr fun h => by have := Nat.dvd_gcd dp h; simp_all +decide [ ( by ring : k * ( 3 * k + 3 ) + 1 = k * ( 3 * k + 3 ) + 1 ) ] ;
      exact ( Nat.Coprime.dvd_of_dvd_mul_left ( show Nat.Coprime ( p ^ 2 ) 9 by exact Nat.Coprime.pow_left 2 <| pp.coprime_iff_not_dvd.mpr fun h => p3 <| by have := Nat.le_of_dvd ( by decide ) h; interval_cases p <;> trivial ) h_div_9k );
    · convert powerful_3k_sq_plus_3k_plus_1 k _ using 1;
      simpa [ ← hm ] using h1

/-
A number is powerful away from 3 if every prime factor p != 3 appears with exponent >= 2.
-/
def PowerfulAwayFromThree (n : ℕ) : Prop :=
  ∀ p : ℕ, p.Prime → p ≠ 3 → p ∣ n → p ^ 2 ∣ n

/-
If m ≡ 2 (mod 3) and m^3-1 is powerful, then m-1 is powerful.
-/
lemma powerful_m_minus_1_of_m_eq_2_mod_3 (m : ℕ) (h_mod : m % 3 = 2) (h_pow : Powerful (m^3 - 1)) : Powerful (m - 1) := by
  -- Since m^3 - 1 = (m - 1)(m^2 + m + 1) and m ≡ 2 (mod 3), we know that m - 1 and m^2 + m + 1 are coprime.
  have h_coprime : Nat.Coprime (m - 1) (m^2 + m + 1) := by
    rcases m with ( _ | _ | m ) <;> simp_all +arith +decide [ Nat.mul_succ, sq ];
    norm_num [ ( by ring : 3 * m + ( m + 2 ) * m + 7 = ( m + 1 ) * ( m + 4 ) + 3 ) ];
    exact Nat.Coprime.symm ( Nat.prime_three.coprime_iff_not_dvd.mpr fun h => by omega );
  convert powerful_of_coprime_mul_powerful h_coprime _ |> And.left;
  rwa [ show ( m - 1 ) * ( m ^ 2 + m + 1 ) = m ^ 3 - 1 by zify; cases m <;> norm_num ; linarith ]

/-
If m ≡ 2 (mod 3) and m^3-1 is powerful, then m^2+m+1 is powerful.
-/
lemma powerful_m_sq_plus_m_plus_1_of_m_eq_2_mod_3 (m : ℕ) (h_mod : m % 3 = 2) (h_pow : Powerful (m^3 - 1)) : Powerful (m^2 + m + 1) := by
  exact powerful_of_m_eq_2_mod_3_left m h_mod h_pow

/-
If m ≡ 2 (mod 3), then m-1 and m^2+m+1 are powerful, (m^2-m+1)/3 is powerful, and (m+1)/3 is powerful away from 3.
-/
lemma consequences_of_m_eq_2_mod_3_corrected (n m : ℕ) (h1 : Powerful n) (h3 : Powerful (n + 2)) (hm : n + 1 = m ^ 3) (h_mod : m % 3 = 2) :
  Powerful (m - 1) ∧ Powerful (m ^ 2 + m + 1) ∧ PowerfulAwayFromThree ((m + 1) / 3) ∧ Powerful ((m ^ 2 - m + 1) / 3) := by
    -- Let's first show that $m-1$ and $m^2+m+1$ are powerful.
    have h1 : Powerful (m - 1) := by
      apply powerful_m_minus_1_of_m_eq_2_mod_3 m h_mod;
      simpa [ ← hm ] using h1
    have h2 : Powerful (m ^ 2 + m + 1) := by
      apply powerful_m_sq_plus_m_plus_1_of_m_eq_2_mod_3 m h_mod;
      convert ‹Powerful n› using 1 ; omega;
    -- Since $m \equiv 2 \pmod{3}$, we have $m^2 - m + 1 = 3B$ where $B = (m^2 - m + 1) / 3$.
    obtain ⟨B, hB⟩ : ∃ B, m ^ 2 - m + 1 = 3 * B := by
      rw [ ← Nat.mod_add_div ( m ^ 2 ) 3, ← Nat.mod_add_div m 3 ] ; norm_num [ Nat.pow_mod, h_mod ] ; ring_nf ;
      exact exists_eq_mul_left_of_dvd ( Nat.dvd_of_mod_eq_zero ( by omega ) );
    -- Since $m \equiv 2 \pmod{3}$, we have $m + 1 = 3A$ where $A = (m + 1) / 3$.
    obtain ⟨A, hA⟩ : ∃ A, m + 1 = 3 * A := by
      exact Nat.dvd_of_mod_eq_zero ( by norm_num [ Nat.add_mod, h_mod ] )
    have h_n2 : n + 2 = 9 * A * B := by
      rw [ tsub_add_eq_add_tsub ( by nlinarith only [ hm ] ), tsub_eq_iff_eq_add_of_le ( by nlinarith only [ hm ] ) ] at hB ; nlinarith only [ hm, hA, hB ] ;
    have h_gcd_AB : Nat.gcd A B = 1 := by
      -- Since $m \equiv 2 \pmod{3}$, we have $\gcd(m + 1, m^2 - m + 1) = \gcd(3A, 3B) = 3 \gcd(A, B)$.
      have h_gcd : Nat.gcd (m + 1) (m ^ 2 - m + 1) = 3 * Nat.gcd A B := by
        rw [ hA, hB, Nat.gcd_mul_left ];
      have h_gcd_div_3 : Nat.gcd (m + 1) (m ^ 2 - m + 1) ∣ 3 := by
        exact?;
      simp_all +decide [ Nat.dvd_prime ]
    have h_B_powerful : Powerful B := by
      -- Since $n+2 = 9AB$ is powerful and $A$ and $B$ are coprime, $B$ must be powerful.
      have h_B_powerful : Powerful (9 * A * B) := by
        exact h_n2 ▸ h3;
      have h_B_powerful : Powerful (9 * A * B) → Nat.gcd (9 * A) B = 1 → Powerful B := by
        intros hB h_coprime
        apply (powerful_of_coprime_mul_powerful h_coprime hB).right;
      apply h_B_powerful; assumption; (
      simp_all +decide [ Nat.coprime_mul_iff_left, Nat.coprime_mul_iff_right ];
      -- Since $B$ is not divisible by 3, we have $\gcd(9, B) = 1$.
      have h_not_div_3 : ¬(3 ∣ B) := by
        rintro ⟨ k, rfl ⟩ ; replace hB := congr_arg ( · % 9 ) hB ; rw [ ← Nat.mod_add_div m 3, h_mod ] at hB ; ring_nf at hB ; norm_num [ Nat.add_mod, Nat.mul_mod ] at hB;
        omega;
      exact ⟨Nat.Coprime.pow_left 2 (Nat.prime_three.coprime_iff_not_dvd.mpr h_not_div_3), h_gcd_AB⟩)
    have h_A_powerful_away_from_3 : PowerfulAwayFromThree A := by
      intro p pp p3 dp; have := h3 p pp; simp_all +decide [ mul_assoc, Nat.Prime.dvd_mul ] ;
      -- Since $p \neq 3$, we have $p^2 \mid 9 * (A * B)$ implies $p^2 \mid A * B$.
      have h_div_AB : p ^ 2 ∣ A * B := by
        exact ( Nat.Coprime.dvd_of_dvd_mul_left ( show Nat.Coprime ( p ^ 2 ) 9 by exact Nat.Coprime.pow_left 2 <| pp.coprime_iff_not_dvd.mpr fun h => p3 <| by have := Nat.le_of_dvd ( by decide ) h; interval_cases p <;> trivial ) this );
      exact ( Nat.Coprime.dvd_of_dvd_mul_right ( show Nat.Coprime ( p ^ 2 ) B from by simpa using pp.coprime_iff_not_dvd.mpr fun h => by have := Nat.dvd_gcd dp h; aesop ) h_div_AB )
    aesop