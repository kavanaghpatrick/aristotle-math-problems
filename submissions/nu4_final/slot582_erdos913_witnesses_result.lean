/-
This file was generated by Aristotle (https://aristotle.harmonic.fun).

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 08edf97f-efd1-4f13-8201-626f148dd11b

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>
-/

/-
We prove that there exist at least 10 natural numbers n such that the prime factorization of n(n+1) has all distinct exponents.
We define `distinct_exponents n` as the property that the factorization function is injective on the prime factors of n(n+1).
We identify a family of witnesses of the form n = 8p^2 - 1 where p is an odd prime and 8p^2 - 1 is prime.
For such n, n(n+1) = (8p^2 - 1) * 8p^2 = (8p^2 - 1) * 2^3 * p^2.
The prime factors are 8p^2 - 1, 2, and p, with exponents 1, 3, and 2 respectively, which are distinct.
We verify this property for 9 witnesses of this form (p = 3, 5, 11, 17, 19, 23, 31, 59, 67) and one special case (n = 31, p = 2).
We define the set of these 10 witnesses and prove its cardinality is 10.
Finally, we prove `10 ≤ Set.encard { n | distinct_exponents n }` using the monotonicity of `encard`.
Note: We use `Set.encard` instead of `Set.ncard` because the set of such numbers is conjectured to be infinite (Erdős 913), and `Set.ncard` is defined as 0 for infinite sets in Mathlib, which would make the inequality `10 ≤ Set.ncard ...` false if the conjecture is true. `Set.encard` correctly captures the "at least 10" condition regardless of finiteness.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
A number n has distinct exponents if the factorization function is injective on the prime factors of n(n+1).
-/
def distinct_exponents (n : ℕ) : Prop :=
  Set.InjOn (n * (n + 1)).factorization (n * (n + 1)).primeFactors

/-
If p is an odd prime and 8p^2-1 is prime, then n = 8p^2-1 has distinct exponents in n(n+1).
-/
lemma distinct_exponents_of_form {p : ℕ} (hp : p.Prime) (hp_odd : p ≠ 2) (h_form : (8 * p ^ 2 - 1).Prime) :
  distinct_exponents (8 * p ^ 2 - 1) := by
    -- By definition of $distinct_exponents$, we need to show that the exponents of the prime factors of $n * (n + 1)$ are distinct.
    unfold distinct_exponents
    have h_prime_factors : (8 * p ^ 2 - 1).primeFactors = {8 * p ^ 2 - 1} := by
      exact h_form.primeFactors
    have h_prime_factors_succ : (8 * p ^ 2).primeFactors = {2, p} := by
      rw [ Nat.primeFactors_mul, Nat.primeFactors_pow ] <;> norm_num [ hp ];
      · rw [ show ( 8 : ℕ ) = 2 ^ 3 by norm_num, Nat.primeFactors_pow ] <;> norm_num ; aesop;
      · exact hp.ne_zero
    have h_factorization : (8 * p ^ 2 - 1).factorization = fun q => if q = 8 * p ^ 2 - 1 then 1 else 0 := by
      ext q; aesop
    have h_factorization_succ : (8 * p ^ 2).factorization = fun q => if q = 2 then 3 else if q = p then 2 else 0 := by
      rw [ Nat.factorization_mul ] <;> norm_num [ hp.ne_zero ];
      rw [ show ( 8 : ℕ ) = 2 ^ 3 by norm_num, Nat.factorization_pow ] ; norm_num [ hp ] ; aesop;
    simp_all +decide [ Set.disjoint_left ];
    -- Let's simplify the prime factors of the product $(8p^2 - 1)(8p^2)$.
    have h_prime_factors_prod : ((8 * p ^ 2 - 1) * (8 * p ^ 2)).primeFactors = {8 * p ^ 2 - 1, 2, p} := by
      rw [ Nat.primeFactors_mul ( Nat.sub_ne_zero_of_lt ( by nlinarith only [ hp.two_le ] ) ) ( by aesop ), h_prime_factors_succ ] ; aesop;
    -- Let's simplify the factorization of the product $(8p^2 - 1)(8p^2)$.
    have h_factorization_prod : ((8 * p ^ 2 - 1) * (8 * p ^ 2)).factorization = fun q => if q = 8 * p ^ 2 - 1 then 1 else if q = 2 then 3 else if q = p then 2 else 0 := by
      rw [ Nat.factorization_mul ] <;> simp_all +decide [ Nat.Prime.ne_zero ];
      ext q; by_cases hq : q = 8 * p ^ 2 - 1 <;> by_cases hq' : q = 2 <;> by_cases hq'' : q = p <;> simp +decide [ hq, hq', hq'' ] ;
      all_goals split_ifs <;> norm_num at *;
      any_goals omega;
      rw [ Nat.sub_eq_iff_eq_add ] at * <;> nlinarith only [ hp.two_le, ‹_› ];
    simp_all +decide [ Nat.sub_add_cancel ( show 1 ≤ 8 * p ^ 2 from Nat.mul_pos ( by decide ) ( pow_pos hp.pos _ ) ) ];
    simp +decide [ Set.InjOn ];
    grind

/-
31 is a witness.
-/
lemma distinct_exponents_31 : distinct_exponents 31 := by
  -- By definition of $distinct_exponents$, we need to show that the exponents in the factorization of $31$ are distinct.
  unfold distinct_exponents; norm_num; (
  native_decide +revert); -- We need to show that the exponents in the factorization of $31$ are distinct. Since $31$ is prime, its only exponent is $1$. Hence, the exponents are distinct.

/-
The numbers 71, 199, 967, 2311, 2887, 4231, 7687, 27847, 35911 are witnesses.
-/
lemma distinct_exponents_71 : distinct_exponents 71 := by
  -- By definition of distinct exponents, we need to show that the exponents in the prime factorization of $71 \cdot 72$ are distinct.
  unfold distinct_exponents;
  native_decide +revert
lemma distinct_exponents_199 : distinct_exponents 199 := by
  -- Apply the lemma distinct_exponents_of_form with p=5.
  apply distinct_exponents_of_form (by norm_num : Nat.Prime 5) (by norm_num : 5 ≠ 2) (by norm_num : Nat.Prime (8 * 5 ^ 2 - 1))
lemma distinct_exponents_967 : distinct_exponents 967 := by
  -- By definition of $distinct\_exponents$, we need to show that the prime factorization of $967 * (967 + 1)$ has distinct exponents.
  unfold distinct_exponents;
  native_decide
lemma distinct_exponents_2311 : distinct_exponents 2311 := by
  -- By definition of $distinct_exponents$, we need to show that the exponents in the factorization of $2311 \cdot 2312$ are distinct.
  unfold distinct_exponents
  skip
  skip
  skip
  native_decide +revert
lemma distinct_exponents_2887 : distinct_exponents 2887 := by
  -- By definition of $distinct_exponents$, we need to show that the exponents in the factorization of $2887 \cdot 2888$ are distinct.
  unfold distinct_exponents
  skip
  native_decide +revert
lemma distinct_exponents_4231 : distinct_exponents 4231 := by
  -- By definition of $distinct_exponents$, we need to show that the exponents in the factorization of $4231 \cdot 4232$ are distinct.
  unfold distinct_exponents
  skip
  native_decide +revert
lemma distinct_exponents_7687 : distinct_exponents 7687 := by
  -- By definition of $distinct_exponents$, we need to show that the exponents in the factorization of $7687 \cdot 7688$ are distinct.
  unfold distinct_exponents
  skip
  native_decide +revert
lemma distinct_exponents_27847 : distinct_exponents 27847 := by
  -- Apply the lemma that states if $p$ is an odd prime and $8p^2 - 1$ is prime, then $n = 8p^2 - 1$ has distinct exponents in $n(n+1)$.
  apply distinct_exponents_of_form (by norm_num : Nat.Prime 59) (by norm_num : 59 ≠ 2) (by norm_num : Nat.Prime (8 * 59 ^ 2 - 1))
lemma distinct_exponents_35911 : distinct_exponents 35911 := by
  -- By definition of $distinct_exponents$, we need to show that the exponents in the factorization of $35911$ and $35912$ are distinct.
  unfold distinct_exponents;
  native_decide

/-
The set of 10 witnesses.
-/
def witnesses : Finset ℕ := {31, 71, 199, 967, 2311, 2887, 4231, 7687, 27847, 35911}

/-
The set of witnesses has 10 elements.
-/
theorem witnesses_card : witnesses.card = 10 := by
  rfl

/-
Every number in the witness set satisfies the distinct exponents property.
-/
theorem witnesses_subset : ∀ n ∈ witnesses, distinct_exponents n := by
  -- By definition of witnesses, we know that each element in the set satisfies the distinct exponents property. We can apply the corresponding lemma for each element.
  intro n hn
  fin_cases hn <;> [exact distinct_exponents_31; exact distinct_exponents_71; exact distinct_exponents_199; exact distinct_exponents_967; exact distinct_exponents_2311; exact distinct_exponents_2887; exact distinct_exponents_4231; exact distinct_exponents_7687; exact distinct_exponents_27847; exact distinct_exponents_35911]

/-
There are at least 10 natural numbers n such that the prime factorization of n(n+1) has all distinct exponents.
-/
theorem erdos_913_bounded : 10 ≤ Set.encard { n | distinct_exponents n } := by
  -- By definition of $witnesses$, we know that every element in $witnesses$ satisfies $distinct_exponents$.
  have h_witnesses_subset : (witnesses : Set ℕ) ⊆ {n | distinct_exponents n} := by
    exact fun x hx => witnesses_subset x <| by simpa using hx;
  -- By definition of $witnesses$, we know that its cardinality is 10.
  have h_witnesses_card : (witnesses : Set ℕ).encard = 10 := by
    rw [ Set.encard_eq_coe_toFinset_card ] ; native_decide;
  exact h_witnesses_card ▸ Set.encard_mono h_witnesses_subset