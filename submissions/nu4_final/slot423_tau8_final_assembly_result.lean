/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: aa115d86-5779-48c4-b530-fbbf7c51fa24

Aristotle's budget for this request has been reached.
If there is partial progress, it will appear in this file.
If you would like to continue working off of this partial progress,
please submit the same prompt, and add this .lean file in "Optional: Attach a Lean file as context" field.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

open scoped BigOperators Classical

open Finset


variable {V : Type*} [Fintype V] [DecidableEq V]

def isTrianglePacking (G : SimpleGraph V) [DecidableRel G.Adj] (S : Finset (Finset V)) : Prop :=
  S ⊆ G.cliqueFinset 3 ∧
  Set.Pairwise (S : Set (Finset V)) (fun t1 t2 => (t1 ∩ t2).card ≤ 1)

def trianglesSharingEdge (G : SimpleGraph V) [DecidableRel G.Adj] (e : Finset V) : Finset (Finset V) :=
  (G.cliqueFinset 3).filter (fun t => (t ∩ e).card ≥ 2)

def S_e (G : SimpleGraph V) [DecidableRel G.Adj] (M : Finset (Finset V)) (e : Finset V) : Finset (Finset V) :=
  (trianglesSharingEdge G e).filter (fun t => t ≠ e ∧ ∀ f ∈ M, f ≠ e → (t ∩ f).card ≤ 1)

lemma bridge_contains_shared (G : SimpleGraph V) [DecidableRel G.Adj]
    (E F : Finset V) (v : V) (hEF : E ∩ F = {v})
    (T : Finset V) (hT : T ∈ G.cliqueFinset 3)
    (hTE : (T ∩ E).card ≥ 2) (hTF : (T ∩ F).card ≥ 2) :
    v ∈ T := by
      contrapose! hTE; simp_all +decide [ Finset.ext_iff ] ;
      have h_inter : #(T ∩ E) + #(T ∩ F) ≤ 3 := by
        rw [ ← Finset.card_union_add_card_inter ];
        exact le_trans ( add_le_add ( Finset.card_le_card ( show T ∩ E ∪ T ∩ F ⊆ T from Finset.union_subset ( Finset.inter_subset_left ) ( Finset.inter_subset_left ) ) ) ( Finset.card_le_card ( show T ∩ E ∩ ( T ∩ F ) ⊆ ∅ from by aesop ) ) ) ( by simp +decide [ hT.card_eq ] );
      linarith

lemma edge_in_sym2 (T : Finset V) (u v : V) (hu : u ∈ T) (hv : v ∈ T) :
    s(u, v) ∈ T.sym2 := by
  simp only [Finset.mk_mem_sym2_iff]
  exact ⟨hu, hv⟩

lemma middle_no_base_externals (B : Finset V) (v1 v2 b3 : V)
    (hB : B = {v1, v2, b3})
    (h12 : v1 ≠ v2) (h13 : v1 ≠ b3) (h23 : v2 ≠ b3)
    (T : Finset V) (hT_card : T.card = 3)
    (hT_share : 2 ≤ (T ∩ B).card) :
    v1 ∈ T ∨ v2 ∈ T := by
      -- If neither v1 nor v2 were in T, then the intersection T ∩ B would only contain b3, leading to a contradiction with hT_share.
      by_contra h_contra
      have h_inter : T ∩ B ⊆ {b3} := by
        -- Since $v1$ and $v2$ are not in $T$, the intersection $T \cap B$ can only contain $b3$.
        intros x hx
        aesop;
      exact hT_share.not_lt ( lt_of_le_of_lt ( Finset.card_le_card h_inter ) ( by simp +decide [ * ] ) )

lemma triangle_classification (G : SimpleGraph V) [DecidableRel G.Adj]
    (M : Finset (Finset V)) (hM : isTrianglePacking G M)
    (hMaximal : ∀ T ∈ G.cliqueFinset 3, T ∉ M → ∃ E ∈ M, (T ∩ E).card ≥ 2)
    (T : Finset V) (hT : T ∈ G.cliqueFinset 3) :
    T ∈ M ∨
    (∃ E ∈ M, T ∈ S_e G M E) ∨
    (∃ E F : Finset V, E ∈ M ∧ F ∈ M ∧ E ≠ F ∧ (T ∩ E).card ≥ 2 ∧ (T ∩ F).card ≥ 2) := by
      by_cases hT_in_M : T ∈ M <;> simp_all +decide [ S_e ];
      obtain ⟨ E, hE₁, hE₂ ⟩ := hMaximal T hT hT_in_M
      by_cases hE₃ : ∃ F ∈ M, F ≠ E ∧ 2 ≤ #(T ∩ F);
      · exact Or.inr ⟨ E, hE₁, hE₃.choose, hE₃.choose_spec.1, Ne.symm hE₃.choose_spec.2.1, hE₂, hE₃.choose_spec.2.2 ⟩;
      · refine' Or.inl ⟨ E, hE₁, _, _, _ ⟩ <;> simp_all +decide [ trianglesSharingEdge ];
        · aesop_cat;
        · exact fun f hf hfE => Nat.le_of_lt_succ ( hE₃ f hf hfE )

def has_external (G : SimpleGraph V) [DecidableRel G.Adj] (M : Finset (Finset V)) (E : Finset V) (e : Finset V) : Prop :=
  ∃ T ∈ S_e G M E, e ⊆ T

lemma exists_two_edges_cover_Se (G : SimpleGraph V) [DecidableRel G.Adj]
    (M : Finset (Finset V)) (hM : isTrianglePacking G M)
    (E : Finset V) (hE : E ∈ M) :
    ∃ C ⊆ E.sym2, C.card ≤ 2 ∧ (∀ T ∈ insert E (S_e G M E), ∃ e ∈ C, e ∈ T.sym2) := by
  have := hM.1 hE; simp_all +decide [ SimpleGraph.cliqueFinset ] ;
  rcases this with ⟨ hE₁, hE₂ ⟩ ; rcases Finset.card_eq_three.mp hE₂ with ⟨ u, v, w, hu, hv, hw, h ⟩ ; simp_all +decide [ Finset.subset_iff ] ;
  refine' ⟨ { s(u, v), s(w, w) }, _, _, _, _ ⟩ <;> simp +decide [ * ];
  -- Since $a$ is in $S_e G M {u, v, w}$, it means $a$ is a triangle in $G$ that shares at least two vertices with ${u, v, w}$.
  intro a ha
  have h_inter : (a ∩ {u, v, w}).card ≥ 2 := by
    exact Finset.mem_filter.mp ha |>.2.2 |> fun h => Finset.mem_filter.mp ( Finset.mem_filter.mp ha |>.1 ) |>.2 |> fun h' => by aesop;
  generalize_proofs at *; (
  contrapose! h_inter; simp_all +decide [ Finset.ext_iff ] ;
  exact lt_of_le_of_lt ( Finset.card_le_one.mpr ( by aesop ) ) ( by decide ) ;)

def Bridges (G : SimpleGraph V) [DecidableRel G.Adj] (M : Finset (Finset V)) (E : Finset V) : Finset (Finset V) :=
  (trianglesSharingEdge G E).filter (fun T => T ≠ E ∧ ∃ F ∈ M, F ≠ E ∧ (T ∩ F).card ≥ 2)

def is_active (G : SimpleGraph V) [DecidableRel G.Adj] (M : Finset (Finset V)) (E : Finset V) (e : Finset V) : Prop :=
  (∃ T ∈ S_e G M E, e ⊆ T) ∨ (∃ T ∈ Bridges G M E, e ⊆ T)

def has_bridge (G : SimpleGraph V) [DecidableRel G.Adj] (M : Finset (Finset V)) (E : Finset V) (e : Finset V) : Prop :=
  ∃ T ∈ Bridges G M E, e ⊆ T

def is_bridge_to (G : SimpleGraph V) [DecidableRel G.Adj] (M : Finset (Finset V)) (E F : Finset V) (T : Finset V) : Prop :=
  T ∈ trianglesSharingEdge G E ∧ T ≠ E ∧ F ∈ M ∧ F ≠ E ∧ (T ∩ F).card ≥ 2

lemma bridge_implies_exists_target (G : SimpleGraph V) [DecidableRel G.Adj]
    (M : Finset (Finset V)) (E : Finset V) (T : Finset V)
    (hT : T ∈ Bridges G M E) :
    ∃ F ∈ M, F ≠ E ∧ is_bridge_to G M E F T := by
  simp only [Bridges, Finset.mem_filter] at hT
  obtain ⟨hT_share, hT_ne, h_exists⟩ := hT
  obtain ⟨F, hF_M, hF_ne, hTF⟩ := h_exists
  use F, hF_M, hF_ne
  exact ⟨hT_share, hT_ne, hF_M, hF_ne, hTF⟩

lemma triangle_ne_implies_inter_card_le_2 (A B : Finset V)
    (hA : A.card = 3) (hB : B.card = 3) (h_ne : A ≠ B) :
    (A ∩ B).card ≤ 2 := by
      -- Since A and B are distinct and each has 3 elements, their intersection can't be 3. Otherwise, they would be the same set, which contradicts h_ne. So the intersection must be less than 3.
      have h_inter_lt_3 : (A ∩ B).card < 3 := by
        -- Since A and B are distinct and both have 3 elements, their intersection can't be all of A or all of B. Otherwise, they would be the same set, which contradicts h_ne. So the intersection must be a proper subset of both A and B. Therefore, its cardinality must be less than 3.
        have h_inter_lt_3 : A ∩ B ⊂ A := by
          simp_all +decide [ Finset.ssubset_def, Finset.subset_iff ];
          exact Finset.not_subset.mp fun h => h_ne <| Finset.eq_of_subset_of_card_le h ( by linarith );
        exact lt_of_lt_of_le ( Finset.card_lt_card h_inter_lt_3 ) hA.le;
      -- Since the cardinality of the intersection is less than 3, it must be at most 2.
      apply Nat.le_of_lt_succ h_inter_lt_3

def ActiveTriangles (G : SimpleGraph V) [DecidableRel G.Adj] (M : Finset (Finset V)) (E : Finset V) : Finset (Finset V) :=
  S_e G M E ∪ Bridges G M E

lemma active_triangle_disjoint_from_disjoint_member (G : SimpleGraph V) [DecidableRel G.Adj]
    (M : Finset (Finset V)) (hM : isTrianglePacking G M)
    (A F : Finset V) (hA : A ∈ M) (hF : F ∈ M) (h_disj : Disjoint A F)
    (T : Finset V) (hT : T ∈ ActiveTriangles G M A) :
    (T ∩ F).card ≤ 1 := by
  -- By Lemma~\ref{lem:triangle_ne_implies_inter_card_le_2}, since $T \neq F$, we have $(T \cap F).card \leq 2$.
  have h_inter_le_two : (T ∩ F).card ≤ 2 := by
    have h_inter_le_two : T.card = 3 ∧ F.card = 3 := by
      unfold ActiveTriangles at hT;
      -- Since $T$ is in the union of $S_e G M A$ and $Bridges G M A$, and both $S_e$ and $Bridges$ are subsets of the cliqueFinset of $G$ with size 3, $T$ must be in the cliqueFinset of $G$ with size 3.
      have hT_clique : T ∈ G.cliqueFinset 3 := by
        -- Since $T$ is in the union of $S_e G M A$ and $Bridges G M A$, and both $S_e$ and $Bridges$ are subsets of the cliqueFinset of $G$ with size 3, $T$ must be in the cliqueFinset of $G$ with size 3. Therefore, $T$ is a triangle in $G$.
        have hT_clique : T ∈ trianglesSharingEdge G A := by
          unfold S_e Bridges at hT; aesop;
        exact Finset.mem_filter.mp hT_clique |>.1;
      exact ⟨ Finset.mem_filter.mp hT_clique |>.2.2, hM.1 hF |> fun h => Finset.mem_filter.mp h |>.2.2 ⟩;
    -- By Lemma~\ref{lem:triangle_ne_implies_inter_card_le_2}, since $T \neq F$, we have $(T \cap F).card \leq 2$ because $T$ and $F$ are distinct triangles.
    apply triangle_ne_implies_inter_card_le_2 T F h_inter_le_two.left h_inter_le_two.right;
    rintro rfl;
    unfold ActiveTriangles at hT; simp_all +decide [ Finset.disjoint_left ] ;
    unfold S_e Bridges at hT; simp_all +decide [ Finset.disjoint_left ] ;
    cases hT <;> simp_all +decide [ trianglesSharingEdge ];
    · grind;
    · exact absurd ( Finset.card_le_card ( show T ∩ A ⊆ ∅ from fun x hx => by aesop ) ) ( by aesop );
  interval_cases _ : # ( T ∩ F ) <;> simp_all +decide;
  obtain ⟨ v, hv, w, hw, hvw ⟩ := Finset.one_lt_card.1 ( by linarith ) ; simp_all +decide [ Finset.disjoint_left ] ;
  unfold ActiveTriangles at hT; simp_all +decide [ Finset.disjoint_left ] ;
  unfold S_e Bridges at hT; simp_all +decide [ Finset.disjoint_left ] ;
  obtain h | h := hT <;> simp_all +decide [ trianglesSharingEdge ];
  · exact absurd ( h.2.2 F hF ( by aesop ) ) ( by linarith );
  · have h_card_inter : T ∩ A ⊆ T \ ({v, w} : Finset V) := by
      grind;
    have := Finset.card_le_card h_card_inter; simp_all +decide [ Finset.card_sdiff ] ;
    have := h.1.1.2; simp_all +decide [ Finset.card_sdiff ] ;
    linarith

def is_active_on_edge (G : SimpleGraph V) [DecidableRel G.Adj] (M : Finset (Finset V)) (E : Finset V) (e : Finset V) : Prop :=
  ∃ T ∈ ActiveTriangles G M E, e ⊆ T

lemma active_triangle_shares_two_vertices (G : SimpleGraph V) [DecidableRel G.Adj]
    (M : Finset (Finset V)) (E : Finset V) (hE : E ∈ M)
    (T : Finset V) (e : Finset V) (he : e ⊆ E) (he_card : e.card = 2)
    (h_active : is_active_on_edge G M E e) (h_cover : e ⊆ T)
    (hT_mem : T ∈ ActiveTriangles G M E)
    (hE_card : E.card = 3) :
    T ∩ E = e := by
      -- Since $e$ is a subset of $T$ and $e$ is also a subset of $E$, the intersection $T \cap E$ must contain $e$. But since $e$ has two elements and $E$ has three, the intersection can't be larger than two elements. Therefore, $T \cap E$ must be exactly $e$. We can use the fact that $e$ is a subset of $T \cap E$ and that $T \cap E$ has at most two elements to conclude they are equal.
      have h_inter_eq : e ⊆ T ∩ E ∧ (T ∩ E).card ≤ 2 := by
        -- Since $T$ is in the active triangles, which are either in $S_e$ or bridges, and by the properties of these sets, $T \cap E$ must have at most two elements.
        have h_inter_card : (T ∩ E).card ≤ 2 := by
          have hT_clique : T ∈ G.cliqueFinset 3 := by
            -- Since $T$ is in the active triangles, which are either in $S_e$ or bridges, and both of these sets are subsets of the cliqueFinset 3, we can conclude that $T$ is in the cliqueFinset 3.
            have hT_clique : T ∈ G.cliqueFinset 3 := by
              have hT_in_clique : T ∈ trianglesSharingEdge G E := by
                exact Finset.mem_union.mp hT_mem |> Or.rec ( fun h => Finset.mem_filter.mp h |>.1 ) fun h => Finset.mem_filter.mp h |>.1
              exact Finset.mem_filter.mp hT_in_clique |>.1;
            exact hT_clique
          have hT_card : T.card = 3 := by
            simp_all +decide [ SimpleGraph.cliqueFinset ];
            exact hT_clique.card_eq
          have hE_card : E.card = 3 := by
            exact hE_card
          have hT_ne_E : T ≠ E := by
            rintro rfl; simp_all +decide [ ActiveTriangles ] ;
            unfold S_e Bridges at hT_mem; aesop;
          have h_inter_card : (T ∩ E).card ≤ 2 := by
            exact?
          exact h_inter_card;
        exact ⟨ Finset.subset_inter h_cover he, h_inter_card ⟩;
      rw [ Finset.eq_of_subset_of_card_le h_inter_eq.1 ( by linarith ) ]

lemma active_triangle_shares_two_vertices_v2 (G : SimpleGraph V) [DecidableRel G.Adj]
    (M : Finset (Finset V)) (E : Finset V) (hE : E ∈ M)
    (T : Finset V) (e : Finset V) (he : e ⊆ E) (he_card : e.card = 2)
    (h_cover : e ⊆ T)
    (hT_mem : T ∈ ActiveTriangles G M E)
    (hE_card : E.card = 3) :
    T ∩ E = e := by
  have hT_clique : T ∈ G.cliqueFinset 3 := by
    unfold ActiveTriangles at hT_mem
    rcases Finset.mem_union.mp hT_mem with h | h
    · unfold S_e at h
      exact (Finset.mem_filter.mp (Finset.mem_filter.mp h).1).1
    · unfold Bridges at h
      exact (Finset.mem_filter.mp (Finset.mem_filter.mp h).1).1
  rw [SimpleGraph.mem_cliqueFinset_iff] at hT_clique
  have h_T_card : T.card = 3 := hT_clique.2
  have h_T_ne_E : T ≠ E := by
    unfold ActiveTriangles at hT_mem
    rcases Finset.mem_union.mp hT_mem with h | h
    · exact (Finset.mem_filter.mp h).2.1
    · exact (Finset.mem_filter.mp h).2.1
  have h_inter_le_2 : (T ∩ E).card ≤ 2 := by
    apply triangle_ne_implies_inter_card_le_2 T E h_T_card hE_card h_T_ne_E
  have h_e_sub_inter : e ⊆ T ∩ E := Finset.subset_inter h_cover he
  have h_eq : e = T ∩ E := by
    apply Finset.eq_of_subset_of_card_le h_e_sub_inter
    rw [he_card]
    exact h_inter_le_2
  exact h_eq.symm

lemma active_triangles_distinct_on_edges (G : SimpleGraph V) [DecidableRel G.Adj]
    (M : Finset (Finset V)) (E : Finset V) (hE : E ∈ M)
    (T1 T2 : Finset V) (e1 e2 : Finset V)
    (he1 : e1 ⊆ E) (he1_card : e1.card = 2)
    (he2 : e2 ⊆ E) (he2_card : e2.card = 2)
    (h_active1 : is_active_on_edge G M E e1) (h_cover1 : e1 ⊆ T1)
    (h_active2 : is_active_on_edge G M E e2) (h_cover2 : e2 ⊆ T2)
    (h_diff : e1 ≠ e2)
    (hT1_mem : T1 ∈ ActiveTriangles G M E)
    (hT2_mem : T2 ∈ ActiveTriangles G M E)
    (hE_card : E.card = 3) :
    T1 ≠ T2 := by
  intro h_eq
  rw [h_eq] at h_cover1
  have h_inter : T2 ∩ E = e2 := active_triangle_shares_two_vertices_v2 G M E hE T2 e2 he2 he2_card h_cover2 hT2_mem hE_card
  have h_sub : e1 ⊆ T2 ∩ E := Finset.subset_inter h_cover1 he1
  rw [h_inter] at h_sub
  have h_eq_edges : e1 = e2 := Finset.eq_of_subset_of_card_le h_sub (by rw [he1_card, he2_card])
  exact h_diff h_eq_edges

lemma active_triangles_distinct_on_edges_v2 (G : SimpleGraph V) [DecidableRel G.Adj]
    (M : Finset (Finset V)) (E : Finset V) (hE : E ∈ M)
    (T1 T2 : Finset V) (e1 e2 : Finset V)
    (he1 : e1 ⊆ E) (he1_card : e1.card = 2)
    (he2 : e2 ⊆ E) (he2_card : e2.card = 2)
    (h_active1 : is_active_on_edge G M E e1) (h_cover1 : e1 ⊆ T1)
    (h_active2 : is_active_on_edge G M E e2) (h_cover2 : e2 ⊆ T2)
    (h_diff : e1 ≠ e2)
    (hT1_mem : T1 ∈ ActiveTriangles G M E)
    (hT2_mem : T2 ∈ ActiveTriangles G M E)
    (hE_card : E.card = 3) :
    T1 ≠ T2 := by
  intro h_eq
  rw [h_eq] at h_cover1
  have h_inter : T2 ∩ E = e2 := active_triangle_shares_two_vertices_v2 G M E hE T2 e2 he2 he2_card h_cover2 hT2_mem hE_card
  have h_sub : e1 ⊆ T2 ∩ E := Finset.subset_inter h_cover1 he1
  rw [h_inter] at h_sub
  have h_eq_edges : e1 = e2 := Finset.eq_of_subset_of_card_le h_sub (by rw [he1_card, he2_card])
  exact h_diff h_eq_edges

def has_Se (G : SimpleGraph V) [DecidableRel G.Adj] (M : Finset (Finset V)) (E : Finset V) (e : Finset V) : Prop :=
  ∃ T ∈ S_e G M E, e ⊆ T

def has_Bridge (G : SimpleGraph V) [DecidableRel G.Adj] (M : Finset (Finset V)) (E : Finset V) (e : Finset V) : Prop :=
  ∃ T ∈ Bridges G M E, e ⊆ T