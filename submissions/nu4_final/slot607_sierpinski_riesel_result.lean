/-
This file was generated by Aristotle (https://aristotle.harmonic.fun).

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: c1b38dee-3a6b-4fa7-b6b1-af68f12ad377

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>
-/

/-
This module formalizes the definitions of Sierpiński and Riesel numbers and proves that 78557 is a Sierpiński number and 509203 is a Riesel number using the covering set method.

Key definitions:
- `IsSierpinskiNumber k`: k * 2^n + 1 is composite for all n ≥ 1.
- `IsRieselNumber k`: k * 2^n - 1 is composite for all n ≥ 1.
- `CoveringTriple`: A structure representing a triple (p, r, m) for covering sets.
- `IsCoveringSetFor S k`: Predicate checking if S is a covering set for a Sierpiński number k.
- `IsCoveringSetForRiesel S k`: Predicate checking if S is a covering set for a Riesel number k.

Key theorems:
- `covering_implies_sierpinski`: Proves that if a valid covering set exists for k (with primes < k), then k is a Sierpiński number.
- `covering_implies_riesel`: Analogous theorem for Riesel numbers.
- `sierpinski_78557`: Formal proof that 78557 is a Sierpiński number.
- `riesel_509203`: Formal proof that 509203 is a Riesel number.

The proofs rely on `native_decide` to verify the covering conditions for the specific finite sets of moduli.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
A number k is a Sierpiński number if k * 2^n + 1 is composite for all n ≥ 1.
-/
def IsSierpinskiNumber (k : ℕ) : Prop :=
  ∀ n : ℕ, 1 ≤ n → ¬ (k * 2 ^ n + 1).Prime

/-
A number k is a Riesel number if k * 2^n - 1 is composite for all n ≥ 1.
-/
def IsRieselNumber (k : ℕ) : Prop :=
  ∀ n : ℕ, 1 ≤ n → ¬ (k * 2 ^ n - 1).Prime

/-
A list of triples (p, r, m) is a covering set for k if each p > 1 and for every n ≥ 1, there exists a triple such that n ≡ r (mod m) and p divides k * 2^n + 1.
-/
structure CoveringTriple where
  p : ℕ
  r : ℕ
  m : ℕ

def IsCoveringSetFor (S : List CoveringTriple) (k : ℕ) : Prop :=
  (∀ t ∈ S, 1 < t.p) ∧
  (∀ n : ℕ, 1 ≤ n → ∃ t ∈ S, n ≡ t.r [MOD t.m] ∧ t.p ∣ k * 2 ^ n + 1)

theorem covering_implies_sierpinski {k : ℕ} (S : List CoveringTriple)
    (h : IsCoveringSetFor S k) (hk : ∀ t ∈ S, t.p < k) : IsSierpinskiNumber k := by
  intro n hn;
  cases' h.2 n hn with t ht;
  rw [ Nat.prime_def_lt' ];
  exact fun H => H.2 _ ( Nat.succ_le_of_lt ( h.1 t ht.1 ) ) ( by nlinarith [ Nat.pow_le_pow_right two_pos hn, hk t ht.1 ] ) ht.2.2

/-
The covering set for k = 78557.
-/
def Sierpinski78557Set : List CoveringTriple := [
  {p := 3, r := 0, m := 2},
  {p := 5, r := 1, m := 4},
  {p := 7, r := 1, m := 3},
  {p := 13, r := 11, m := 12},
  {p := 19, r := 15, m := 18},
  {p := 37, r := 27, m := 36},
  {p := 73, r := 3, m := 9}
]

lemma covering_periodicity (S : List CoveringTriple) (k : ℕ) (L : ℕ)
    (hL_pos : L > 0)
    (hL : ∀ t ∈ S, t.m ∣ L)
    (h_ord : ∀ t ∈ S, 2 ^ t.m ≡ 1 [MOD t.p])
    (h_cover : ∀ n, 1 ≤ n → n ≤ L → ∃ t ∈ S, n ≡ t.r [MOD t.m] ∧ t.p ∣ k * 2 ^ n + 1) :
    ∀ n, 1 ≤ n → ∃ t ∈ S, n ≡ t.r [MOD t.m] ∧ t.p ∣ k * 2 ^ n + 1 := by
  intro n hn; by_cases hnL : n ≤ L; aesop;
  -- Let n' = (n - 1) % � L� + 1.
  set n' := (n - 1) % L + 1;
  -- By h_cover, there exists t ∈ S such that n' t.r [MOD t.m] and t.p k * 2^n' + 1.
  obtain ⟨t, htS, ht_mod, ht_div⟩ : ∃ t ∈ S, n' ≡ t.r [MOD t.m] ∧ t.p ∣ k * 2 ^ n' + 1 := by
    exact h_cover n' ( Nat.succ_pos _ ) ( Nat.succ_le_of_lt ( Nat.mod_lt _ hL_pos ) );
  -- Since $n \equiv n' \pmod{t.m}$ and $2^{t.m} \equiv 1 \pmod{t.p}$, we have $ �2�^n \equiv 2^{n'} \pmod{t.p}$.
  have h_exp_mod : 2 ^ n ≡ 2 ^ n' [MOD t.p] := by
    -- Since $n \equiv n' \pmod{t.m}$ and $2^{t.m} \equiv 1 \pmod{t.p}$, we have $2^n \equiv 2^{n'} \p �mod�{t.p}$.
    have h_exp_mod : n ≡ n' [MOD t.m] := by
      simp_all +decide [ Nat.ModEq, Nat.mod_eq_zero_of_dvd ( hL _ htS ) ];
      rw [ ← ht_mod, Nat.ModEq.symm ];
      cases n <;> simp_all +decide [ Nat.succ_eq_add_one, Nat.modEq_iff_dvd ];
      simp +zetaDelta at *;
      exact dvd_trans ( mod_cast hL t htS ) ( Int.dvd_self_sub_of_emod_eq rfl );
    rw [ ← Nat.mod_add_div n t.m, ← Nat.mod_add_div n' t.m, h_exp_mod ] ; simp_all +decide [ ← ZMod.natCast_eq_natCast_iff, pow_add, pow_mul ] ;
  use t, htS;
  simp_all +decide [ ← ZMod.natCast_eq_zero_iff, ← ZMod.natCast_eq_natCast_iff ];
  rw [ show n = ( n - 1 ) % L + 1 + ( n - 1 ) / L * L by linarith [ Nat.mod_add_div ( n - 1 ) L, Nat.sub_add_cancel hn ] ] ; aesop

theorem sierpinski_78557_is_covering : IsCoveringSetFor Sierpinski78557Set 78557 := by
  constructor;
  · decide +kernel;
  · intros n hn; by_contra h_contra; simp_all +decide [ Sierpinski78557Set ] ;
    norm_num [ Nat.ModEq, Nat.dvd_iff_mod_eq_zero, Nat.add_mod, Nat.mul_mod, Nat.pow_mod ] at *;
    rw [ ← Nat.mod_add_div n 36 ] at *; norm_num [ Nat.pow_add, Nat.pow_mul, Nat.mul_mod, Nat.pow_mod ] at *; have := Nat.mod_lt n ( by decide : 0 < 36 ) ; interval_cases n % 36 <;> simp +decide at h_contra ⊢;
    all_goals norm_num [ Nat.add_mod, Nat.mul_mod ] at h_contra;

/-
78557 is a Sierpiński number.
-/
theorem sierpinski_78557 : IsSierpinskiNumber 78557 := by
  apply covering_implies_sierpinski Sierpinski78557Set
  · exact sierpinski_78557_is_covering
  · decide

/-
A list of triples (p, r, m) is a covering set for a Riesel number k if each p > 1 and for every n ≥ 1, there exists a triple such that n ≡ r (mod m) and p divides k * 2^n - 1.
-/
def IsCoveringSetForRiesel (S : List CoveringTriple) (k : ℕ) : Prop :=
  (∀ t ∈ S, 1 < t.p) ∧
  (∀ n : ℕ, 1 ≤ n → ∃ t ∈ S, n ≡ t.r [MOD t.m] ∧ t.p ∣ k * 2 ^ n - 1)

theorem covering_implies_riesel {k : ℕ} (S : List CoveringTriple)
    (h : IsCoveringSetForRiesel S k) (hk : ∀ t ∈ S, t.p < k) : IsRieselNumber k := by
  intro n hn
  obtain ⟨t, ht_mem, ht_mod, ht_div⟩ := h.right n hn
  have ht_composite : ¬Nat.Prime (k * 2 ^ n - 1) := by
    intro H_prime
    have ht_proper_divisor : t.p < k * 2 ^ n - 1 := by
      refine lt_of_lt_of_le ( hk t ht_mem ) ?_;
      exact Nat.le_sub_one_of_lt ( lt_mul_of_one_lt_right ( Nat.pos_of_ne_zero ( by aesop_cat ) ) ( one_lt_pow₀ ( by decide ) ( by linarith ) ) )
    have ht_gt_one : 1 < t.p := by
      exact h.1 t ht_mem
    exact (by
    rw [ H_prime.dvd_iff_eq ] at ht_div <;> linarith)
  exact ht_composite

/-
The covering set for the Riesel number k = 509203.
-/
def Riesel509203Set : List CoveringTriple := [
  {p := 3, r := 0, m := 2},
  {p := 5, r := 1, m := 4},
  {p := 7, r := 2, m := 3},
  {p := 13, r := 7, m := 12},
  {p := 17, r := 7, m := 8},
  {p := 241, r := 3, m := 24}
]

lemma covering_periodicity_riesel (S : List CoveringTriple) (k : ℕ) (L : ℕ)
    (hL_pos : L > 0)
    (hL : ∀ t ∈ S, t.m ∣ L)
    (h_ord : ∀ t ∈ S, 2 ^ t.m ≡ 1 [MOD t.p])
    (h_cover : ∀ n, 1 ≤ n → n ≤ L → ∃ t ∈ S, n ≡ t.r [MOD t.m] ∧ t.p ∣ k * 2 ^ n - 1) :
    ∀ n, 1 ≤ n → ∃ t ∈ S, n ≡ t.r [MOD t.m] ∧ t.p ∣ k * 2 ^ n - 1 := by
  intros n hn
  set n' := (n - 1) % L + 1;
  -- By h_cover, there exists t ∈ S such that n�'� � ⟡� t.r [MOD t.m] and t.p k * 2^n' - 1.
  obtain ⟨t, htS, ht_mod, ht_div⟩ : ∃ t ∈ S, n' ≡ t.r [MOD t.m] ∧ t.p ∣ k * 2 ^ n' - 1 := by
    exact h_cover n' ( Nat.succ_pos _ ) ( Nat.succ_le_of_lt ( Nat.mod_lt _ hL_pos ) );
  -- Since $n \equiv n' \pmod{t.m}$ and $2^{t.m} \equiv 1 \pmod{t.p}$, we have $ �2�^n \equiv 2^{n'} \pmod{t.p}$.
  have h_exp_mod : 2 ^ n ≡ 2 ^ n' [MOD t.p] := by
    -- Since $n \equiv n �'� \pmod{t.m}$, we have $2^n \equiv 2^{n'} \pmod{t.p}$ by the properties of modular arithmetic.
    have h_exp_mod : n ≡ n' [MOD t.m] := by
      have ht_mod_n : n ≡ n' [MOD L] := by
        cases n <;> simp_all +decide [ Nat.ModEq, Nat.mod_eq_of_lt ];
        simp +zetaDelta at *;
      exact ht_mod_n.of_dvd <| hL t htS;
    rw [ ← Nat.mod_add_div n t.m, ← Nat.mod_add_div n' t.m, h_exp_mod ] ; simp_all +decide [ ← ZMod.natCast_eq_natCast_iff, pow_add, pow_mul ] ;
  refine' ⟨ t, htS, _, _ ⟩ <;> simp_all +decide [ ← ZMod.natCast_eq_natCast_iff ];
  · simp +zetaDelta at *;
    cases n <;> simp_all +decide [ ← ZMod.natCast_eq_natCast_iff' ];
    simp_all +decide [ ← ht_mod, Nat.mod_eq_of_lt ];
    rw [ ZMod.natCast_eq_natCast_iff ];
    rw [ Nat.ModEq, Nat.mod_mod_of_dvd _ ( hL t htS ) ];
  · simp_all +decide [ ← ZMod.natCast_eq_zero_iff ];
    cases k <;> cases n <;> simp_all +decide [ pow_succ', mul_assoc ]

theorem riesel_509203_is_covering : IsCoveringSetForRiesel Riesel509203Set 509203 := by
  -- We'll use the covering_periodicity_riesel lemma with L = 24.
  have h_covering : ∀ n, 1 ≤ n → n ≤ 24 → ∃ t ∈ Riesel509203Set, n ≡ t.r [MOD t.m] ∧ t.p ∣ 509203 * 2 ^ n - 1 := by
    native_decide;
  apply And.intro;
  · native_decide +revert;
  · apply covering_periodicity_riesel;
    exact Nat.succ_pos 23;
    · native_decide;
    · native_decide;
    · assumption

/-
509203 is a Riesel number.
-/
theorem riesel_509203 : IsRieselNumber 509203 := by
  apply covering_implies_riesel Riesel509203Set
  · exact riesel_509203_is_covering
  · decide