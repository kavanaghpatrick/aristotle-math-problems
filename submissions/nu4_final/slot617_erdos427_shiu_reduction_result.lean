/-
This file was generated by Aristotle (https://aristotle.harmonic.fun).

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 5e0f7947-9806-4b82-8726-cb6ea30b6d1a

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>
-/

/-
We formalized Erdős Problem 427 and its relationship to Shiu's Theorem.

1.  **Definitions**:
    *   `erdos427`: The statement of Erdős Problem 427.
    *   `ShiuTheorem`: The statement of Shiu's Theorem (existence of arbitrarily long runs of primes in a residue class).

2.  **Theorems**:
    *   `erdos_427_of_shiu`: A formal proof that Shiu's Theorem implies Erdős Problem 427. This confirms the observation by Cedric Pilatte.
    *   `erdos_427`: A conditional proof of Erdős Problem 427, assuming Shiu's Theorem as a hypothesis.
    *   `check_case_1`, `check_case_2`, `check_case_3`: Computational verification of the conjecture for small values of $n$ and $d$ ($n=1, d=2$; $n=5, d=3$; $n=0, d=5$).

Note: Shiu's Theorem itself is a deep result in number theory (2000) and is not yet available in Mathlib, nor is it feasible to prove from scratch in this context. Thus, we proved the reduction and verified instances.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
Erdős Problem 427: For every n and d (d ≠ 0), there exists k ≠ 0 such that d divides the sum of k consecutive primes starting from the n-th prime.
-/
def erdos427 : Prop := ∀ (n d : ℕ), d ≠ 0 → ∃ k, k ≠ 0 ∧
    d ∣ ∑ i ∈ Finset.Ico n (n + k), Nat.nth Nat.Prime i

/-
Shiu's Theorem: For any k, a, q with gcd(a, q) = 1, there are infinitely many runs of k consecutive primes all congruent to a mod q.
-/
def ShiuTheorem : Prop := ∀ (k a q : ℕ), 1 ≤ k → 1 ≤ q → a.gcd q = 1 →
    { m : ℕ | ∀ p ∈ (Finset.Ico m (m + k)).image (Nat.nth Nat.Prime),
      p ≡ a [MOD q]}.Infinite

/-
Answer wrapper
-/
def answer (p : Prop) := p

/-
Shiu's Theorem implies Erdős Problem 427.
If Shiu's Theorem holds, then for every n and d (d ≠ 0), there exists k ≠ 0 such that d divides the sum of k consecutive primes starting from the n-th prime.
-/
theorem erdos_427_of_shiu (H : ShiuTheorem) : erdos427 := by
  -- Let's choose any $n$ and $d$ with $d \neq 0$.
  intro n d hd
  by_cases hd1 : d = 1;
  · exact ⟨ 1, by norm_num, hd1.symm ▸ one_dvd _ ⟩;
  · -- Apply Shiu's theorem with $k_{shiu} = d$, $a = 1$, $q = d$.
    obtain ⟨m, hm⟩ : ∃ m ≥ n, ∀ p ∈ (Finset.Ico m (m + d)).image (Nat.nth Nat.Prime), p ≡ 1 [MOD d] := by
      have := H d 1 d ( Nat.pos_of_ne_zero hd ) ( Nat.pos_of_ne_zero hd ) ( by aesop );
      exact Exists.elim ( this.exists_gt n ) fun m hm => ⟨ m, hm.2.le, hm.1 ⟩;
    -- Consider the sums extending into the block: for $r \in \{1, \dots, d\}$, let $T_r = S + \sum_{j=m}^{m+r-1} p_j$.
    set S := ∑ i ∈ Finset.Ico n m, Nat.nth Nat.Prime i
    obtain ⟨r, hr⟩ : ∃ r ∈ Finset.Icc 1 d, S + ∑ j ∈ Finset.Ico m (m + r), Nat.nth Nat.Prime j ≡ 0 [MOD d] := by
      -- Since each $p_j \equiv 1 \pmod d$ for $j \in [m, m+d)$, we have $\sum_{j=m}^{m+r-1} p_j \equiv \sum_{j=0}^{r-1} 1 \equiv r \pmod d$.
      have h_sum_cong : ∀ r ∈ Finset.Icc 1 d, ∑ j ∈ Finset.Ico m (m + r), Nat.nth Nat.Prime j ≡ r [MOD d] := by
        simp_all +decide [ ← ZMod.natCast_eq_natCast_iff ];
        exact fun r hr₁ hr₂ => by rw [ Finset.sum_congr rfl fun x hx => hm.2 _ _ ( Finset.mem_Ico.mp hx |>.1 ) ( Finset.mem_Ico.mp hx |>.2.trans_le ( by linarith ) ) rfl ] ; simp +decide [ hr₁, hr₂ ] ;
      simp_all +decide [ ← ZMod.natCast_eq_natCast_iff ];
      -- Since $S$ is a fixed integer, we can choose $r$ such that $r \equiv -S \pmod{d}$.
      obtain ⟨r, hr⟩ : ∃ r ∈ Finset.Icc 1 d, r ≡ -S [ZMOD d] := by
        use Int.toNat ( -S % d ) + if Int.toNat ( -S % d ) = 0 then d else 0;
        split_ifs <;> simp_all +decide [ Int.ModEq, Int.emod_nonneg _ ( by positivity : ( d : ℤ ) ≠ 0 ) ];
        · exact Nat.one_le_iff_ne_zero.mpr ( by positivity );
        · exact ⟨ by linarith, Int.le_of_lt ( Int.emod_lt_of_pos _ ( by positivity ) ) ⟩;
      simp_all +decide [ ← ZMod.intCast_eq_intCast_iff ];
      exact ⟨ r, hr.1, by rw [ h_sum_cong r hr.1.1 hr.1.2, hr.2 ] ; ring ⟩;
    use (m - n) + r;
    simp_all +decide [ ← add_assoc, Nat.modEq_zero_iff_dvd ];
    exact ⟨ fun h => by linarith, by rw [ show Finset.Ico n ( m + r ) = Finset.Ico n m ∪ Finset.Ico m ( m + r ) by rw [ Finset.Ico_union_Ico_eq_Ico ] <;> linarith ] ; rw [ Finset.sum_union ( Finset.disjoint_right.mpr fun x hx => by aesop ) ] ; exact hr.2 ⟩

/-
Erdős Problem 427 (assuming Shiu's Theorem): The statement erdos427 is true.
-/
theorem erdos_427 (H : ShiuTheorem) : answer True ↔ erdos427 := by
  exact iff_of_true trivial ( erdos_427_of_shiu H )

/-
Computational verification of Erdős Problem 427 for small values (n=1, d=2; n=5, d=3; n=0, d=5) using a pre-computed list of primes.
-/
def small_primes : List ℕ := [2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71]

def get_prime (n : ℕ) : ℕ :=
  if h : n < small_primes.length then small_primes.get ⟨n, h⟩ else 0

def check_erdos_427_computable (n d : ℕ) : Bool :=
  if d == 0 then true else
  (List.range 15).any fun k =>
    if k == 0 then false else
    let sum := (List.range k).foldl (fun acc i => acc + get_prime (n + i)) 0
    sum % d == 0

theorem check_case_1 : check_erdos_427_computable 1 2 = true := by native_decide
theorem check_case_2 : check_erdos_427_computable 5 3 = true := by native_decide
theorem check_case_3 : check_erdos_427_computable 0 5 = true := by native_decide