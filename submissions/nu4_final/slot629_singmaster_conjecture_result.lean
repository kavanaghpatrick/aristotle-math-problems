/-
This file was generated by Aristotle (https://aristotle.harmonic.fun).

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 5b23ce45-3f90-432e-8104-ce9cd77be21f

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>
-/

/-
We have formalized Singmaster's conjecture related definitions and proven two main results:
1. `Singmaster.solutions_finite`: For any t > 1, the set of solutions (n, k) to binomial(n, k) = t with 1 ≤ k < n is finite.
2. `Singmaster.solutions_bound_weak`: There exists a constant C such that for all t > 1, the number of solutions is bounded by C * log(t).

The proof relies on several helper lemmas establishing properties of binomial coefficients, including strict monotonicity (`Singmaster.choose_strictMonoOn_n`), lower bounds (`Singmaster.choose_ge_two_pow`), and symmetry arguments.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
Definition of the set of solutions (n, k) to the equation binomial(n, k) = t, subject to 1 ≤ k < n.
-/
def Singmaster.solutions (t : ℕ) : Set (ℕ × ℕ) :=
  {(n, k) | 1 ≤ k ∧ k < n ∧ Nat.choose n k = t}

/-
For any t > 1, the set of solutions (n, k) such that binomial(n, k) = t and 1 ≤ k < n is finite.
-/
theorem Singmaster.solutions_finite (t : ℕ) (ht : 1 < t) : (Singmaster.solutions t).Finite := by
  -- For any fixed $t > 1$, we prove that $\{(n, k) \mid \binom{n}{k} = t, 1 \leq k < n\}$ is finite.
  have h_finite : ∀ k, 1 ≤ k → k < t + 1 → ({n | 1 ≤ k ∧ k < n ∧ Nat.choose n k = t}).Finite := by
    intro k hk₁ hk₂;
    refine Set.finite_iff_bddAbove.mpr ⟨ t * t, fun n hn => ?_ ⟩;
    have h_bound : n.choose k ≥ n.choose 1 := by
      have h_bound : ∀ m, 1 ≤ m → m ≤ n / 2 → n.choose m ≥ n.choose 1 := by
        intros m hm₁ hm₂
        induction' hm₁ with m hm ih;
        · norm_num;
        · have := Nat.choose_succ_right_eq n m;
          nlinarith [ ih ( Nat.le_of_succ_le hm₂ ), Nat.div_mul_le_self n 2, Nat.sub_add_cancel ( show m ≤ n from by linarith [ Nat.div_mul_le_self n 2 ] ) ];
      by_cases hk : k ≤ n / 2;
      · exact h_bound k hk₁ hk;
      · convert h_bound ( n - k ) ( Nat.sub_pos_of_lt hn.2.1 ) ( by omega ) using 1 ; rw [ Nat.choose_symm ( by linarith [ hn.2.1 ] ) ];
    nlinarith [ hn.2.2 ▸ h_bound, Nat.choose_one_right n ];
  -- By definition of $Solutions$, the set of $(n, k)$ pairs satisfying the conditions is a subset of the union of the finite sets corresponding to each $k$.
  have h_subset : {p : ℕ × ℕ | 1 ≤ p.2 ∧ p.2 < p.1 ∧ Nat.choose p.1 p.2 = t} ⊆ ⋃ k ∈ Finset.Ico 1 (t + 1), {p : ℕ × ℕ | p.2 = k ∧ 1 ≤ k ∧ k < p.1 ∧ Nat.choose p.1 k = t} := by
    intros p hp
    obtain ⟨hp1, hp2, hp3⟩ := hp
    have hp4 : p.2 < t + 1 := by
      contrapose! hp3; have := Nat.choose_le_choose ( p.2 ) hp2; simp_all +arith +decide;
      grind
    aesop;
  refine' Set.Finite.subset _ h_subset;
  exact Set.Finite.biUnion ( Finset.finite_toSet _ ) fun k hk => Set.Finite.subset ( Set.Finite.prod ( h_finite k ( Finset.mem_Ico.mp hk |>.1 ) ( Finset.mem_Ico.mp hk |>.2 ) ) ( Set.finite_singleton k ) ) fun p hp => by aesop;

/-
For a fixed k ≥ 1, the binomial coefficient binomial(n, k) is strictly increasing in n for n ≥ k.
-/
theorem Singmaster.choose_strictMonoOn_n {k : ℕ} (hk : 1 ≤ k) :
    StrictMonoOn (fun n => n.choose k) (Set.Ici k) := by
      -- To prove strict monotonicity, we can use the fact that for $n > k$, $\binom{n+1}{k} = \binom{n}{k} + \binom{n}{k-1}$.
      have h_recurrence : ∀ n > k, Nat.choose (n + 1) k = Nat.choose n k + Nat.choose n (k - 1) := by
        cases k <;> simp_all +arith +decide [ Nat.choose ];
      intros n hn m hm hnm;
      -- Apply induction on $m - n$.
      induction' hnm with m ih;
      · rcases k with ( _ | _ | k ) <;> simp_all +arith +decide [ Nat.choose ];
        exact Nat.choose_pos hm;
      · grind

/-
If 1 ≤ k ≤ n/2, then binomial(n, k) ≥ 2^k.
-/
theorem Singmaster.choose_ge_two_pow {n k : ℕ} (hk : 1 ≤ k) (hkn : k ≤ n / 2) :
    2 ^ k ≤ n.choose k := by
      -- We know n ≥ 2k. Since binomial coefficients are increasing in n, C(n,k) ≥ C(2k,k).
      have h_choose_ge : Nat.choose n k ≥ Nat.choose (2 * k) k := by
        exact Nat.choose_le_choose _ ( by linarith [ Nat.div_mul_le_self n 2 ] );
      -- We prove $C(2k,k) \geq 2^k$ by induction on $k$.
      have h_choose_ge_ind : ∀ k : ℕ, 1 ≤ k → Nat.choose (2 * k) k ≥ 2 ^ k := by
        intro k hk; induction hk <;> simp_all +decide [ Nat.pow_succ', Nat.mul_succ, Nat.choose_succ_succ ] ;
        linarith [ Nat.choose_le_succ ( 2 * ‹_› ) ‹_› ];
      exact le_trans ( h_choose_ge_ind k hk ) h_choose_ge

/-
For a fixed k ≥ 1, there is at most one n such that (n, k) is a solution for t.
-/
theorem Singmaster.unique_n_for_fixed_k {t k : ℕ} (hk : 1 ≤ k) :
    {n | (n, k) ∈ Singmaster.solutions t}.ncard ≤ 1 := by
      by_contra h;
      -- If there are two distinct solutions (n₁, k) and (n₂, k) with n₁ < n₂, then the binomial coefficients satisfy:
      obtain ⟨n₁, n₂, hn₁k, hn₂k, hn₁_lt_n₂⟩ : ∃ n₁ n₂, n₁ < n₂ ∧ (n₁, k) ∈ Singmaster.solutions t ∧ (n₂, k) ∈ Singmaster.solutions t := by
        obtain ⟨ n₁, hn₁ ⟩ := Set.nonempty_of_ncard_ne_zero ( by linarith ) ; obtain ⟨ n₂, hn₂ ⟩ := Set.exists_ne_of_one_lt_ncard ( by linarith ) n₁; cases lt_trichotomy n₁ n₂ <;> aesop;
      -- Since $n_1 < n_2$ and both $(n_1, k)$ and $(n_2, k)$ are solutions, we have $\binom{n_1}{k} = \binom{n_2}{k}$.
      have h_binom_eq : Nat.choose n₁ k = Nat.choose n₂ k := by
        exact hn₂k.2.2.trans hn₁_lt_n₂.2.2.symm;
      -- Since $n_1 < n_2$ and both $(n_1, k)$ and $(n_2, k)$ are solutions, we have $\binom{n_1}{k} = \binom{n_2}{k}$, which contradicts the strict monotonicity of the binomial coefficient.
      have h_contradiction : StrictMonoOn (fun n => Nat.choose n k) (Set.Ici k) := by
        exact?;
      exact absurd ( h_contradiction ( show k ≤ n₁ by linarith [ hn₂k.1, hn₂k.2 ] ) ( show k ≤ n₂ by linarith [ hn₁_lt_n₂.1, hn₁_lt_n₂.2 ] ) hn₁k ) ( by aesop )

/-
If (n, k) is a solution for t, then 2^(min(k, n-k)) ≤ t.
-/
theorem Singmaster.solution_bound_k {t n k : ℕ} (h : (n, k) ∈ Singmaster.solutions t) :
    2 ^ (min k (n - k)) ≤ t := by
      -- By definition of $min$, we know that $min(k, n - k) \leq n / 2$.
      have h_min_le_half : min k (n - k) ≤ n / 2 := by
        cases min_cases k ( n - k ) <;> omega;
      -- By definition of $min$, we know that $2^{min(k, n - k)} ≤ \binom{n}{min(k, n - k)}$.
      have h_binom_ge_two_pow : 2 ^ min k (n - k) ≤ Nat.choose n (min k (n - k)) := by
        convert Singmaster.choose_ge_two_pow _ _ using 1;
        · cases min_cases k ( n - k ) <;> linarith [ h.1, h.2.1, Nat.sub_add_cancel h.2.1.le ];
        · assumption;
      cases le_total k ( n - k ) <;> simp_all +decide [ Nat.choose_symm_add ];
      · cases h ; aesop;
      · exact h_binom_ge_two_pow.trans ( by rw [ Nat.choose_symm ( by linarith [ h.2.1 ] ) ] ; linarith [ h.2.2 ] )

/-
The number of solutions (n, k) with k ≤ K is at most K.
-/
theorem Singmaster.card_solutions_le_sum_card_fixed_k {t K : ℕ} :
    ({p ∈ Singmaster.solutions t | p.2 ≤ K}).ncard ≤ K := by
      -- The set of solutions with $k \leq K$ is the union over $k \in \{1, \ldots, K\}$ of solutions with fixed $k$.
      have h_union : {p : ℕ × ℕ | p ∈ Singmaster.solutions t ∧ p.2 ≤ K} = ⋃ k ∈ Finset.Icc 1 K, {p : ℕ × ℕ | p ∈ Singmaster.solutions t ∧ p.2 = k} := by
        ext ⟨n, k⟩
        simp [Singmaster.solutions];
        tauto;
      -- For each fixed $k$, there is at most one solution $(n, k)$ in the set.
      have h_card_fixed_k : ∀ k ∈ Finset.Icc 1 K, Set.ncard {p : ℕ × ℕ | p ∈ Singmaster.solutions t ∧ p.2 = k} ≤ 1 := by
        intro k hk
        have h_unique_n : {n : ℕ | (n, k) ∈ Singmaster.solutions t}.ncard ≤ 1 := by
          apply_rules [ Singmaster.unique_n_for_fixed_k ] ; aesop;
        rw [ show { p : ℕ × ℕ | p ∈ Singmaster.solutions t ∧ p.2 = k } = ( Set.image ( fun n => ( n, k ) ) { n : ℕ | ( n, k ) ∈ Singmaster.solutions t } ) by ext ; aesop ] ; rw [ Set.ncard_image_of_injective _ fun a b h => by injection h ] ; aesop;
      have h_card_union : Set.ncard (⋃ k ∈ Finset.Icc 1 K, {p : ℕ × ℕ | p ∈ Singmaster.solutions t ∧ p.2 = k}) ≤ Finset.sum (Finset.Icc 1 K) (fun k => Set.ncard {p : ℕ × ℕ | p ∈ Singmaster.solutions t ∧ p.2 = k}) := by
        exact?;
      exact h_union ▸ h_card_union.trans ( le_trans ( Finset.sum_le_sum h_card_fixed_k ) ( by norm_num ) )

/-
The number of solutions (n, k) with n - k ≤ K is equal to the number of solutions with k ≤ K.
-/
theorem Singmaster.card_solutions_symm {t K : ℕ} :
    ({p ∈ Singmaster.solutions t | p.1 - p.2 ≤ K}).ncard = ({p ∈ Singmaster.solutions t | p.2 ≤ K}).ncard := by
      fapply Set.ncard_congr;
      use fun p hp => ( p.1, p.1 - p.2 );
      · simp +zetaDelta at *;
        exact fun a b hab h => ⟨ ⟨ Nat.sub_pos_of_lt hab.2.1, Nat.sub_lt ( by linarith [ hab.2.1 ] ) ( by linarith [ hab.1 ] ), by simpa [ Nat.choose_symm ( le_of_lt hab.2.1 ) ] using hab.2.2 ⟩, h ⟩;
      · simp +zetaDelta at *;
        intro a b a_1 b_1 h₁ h₂ h₃ h₄ h₅ h₆; have := h₁.2.1; have := h₃.2.1; omega;
      · simp [Singmaster.solutions];
        exact fun a b hb₁ hb₂ h₁ h₂ => ⟨ a, a - b, ⟨ ⟨ by omega, by omega, by simpa [ hb₂.le ] using h₁ ⟩, by omega ⟩, rfl, by omega ⟩

/-
There exists a constant C such that for all t > 1, the number of solutions (n, k) to binomial(n, k) = t with 1 ≤ k < n is at most C * log(t).
-/
theorem Singmaster.solutions_bound_weak : ∃ (C : ℝ), ∀ (t : ℕ), 1 < t →
    ((Singmaster.solutions t).ncard : ℝ) ≤ C * Real.log t := by
      -- Let $K = \lfloor \log_2 t \rfloor$.
      use 2 / Real.log 2;
      -- By combining the results, we conclude that the number of solutions is at most $2 \log_2 t$.
      intros t ht
      have h_card : ( Singmaster.solutions t |> Set.ncard ) ≤ 2 * Nat.log 2 t := by
        -- By definition of $C$, we know that for any $t > 1$, the number of solutions is at most $C \cdot \log t$. Let $K = \log_2 t$.
        set K := Nat.log 2 t with hK_def
        have h_card : (Singmaster.solutions t).ncard ≤ ({p ∈ Singmaster.solutions t | p.2 ≤ K}).ncard + ({p ∈ Singmaster.solutions t | p.1 - p.2 ≤ K}).ncard := by
          have h_card : (Singmaster.solutions t) ⊆ {p ∈ Singmaster.solutions t | p.2 ≤ K} ∪ {p ∈ Singmaster.solutions t | p.1 - p.2 ≤ K} := by
            intro p hp
            have h_min : min p.2 (p.1 - p.2) ≤ K := by
              have := Singmaster.solution_bound_k hp; exact Nat.le_log_of_pow_le ( by decide ) ( by linarith [ Nat.pow_le_pow_right ( by decide : 1 ≤ 2 ) this ] ) ;
            exact (by
            cases min_cases p.2 ( p.1 - p.2 ) <;> aesop);
          convert Set.ncard_union_le _ _ using 1;
          exact congr_arg _ ( Set.Subset.antisymm h_card fun p hp => by aesop );
        -- By definition of $K$, we know that the number of solutions with $k \leq K$ is at most $K$.
        have h_card_k : ({p ∈ Singmaster.solutions t | p.2 ≤ K}).ncard ≤ K := by
          convert Singmaster.card_solutions_le_sum_card_fixed_k using 1;
        linarith! [ show Set.ncard { p : ℕ × ℕ | p ∈ Singmaster.solutions t ∧ p.1 - p.2 ≤ K } ≤ K from by simpa only [ two_mul ] using Singmaster.card_solutions_symm.symm ▸ h_card_k ];
      field_simp;
      exact le_trans ( mul_le_mul_of_nonneg_right ( Nat.cast_le.mpr h_card ) ( Real.log_nonneg ( by norm_num ) ) ) ( by simpa [ mul_assoc, mul_comm, mul_left_comm ] using mul_le_mul_of_nonneg_left ( Real.log_le_log ( by positivity ) ( show ( t : ℝ ) ≥ 2 ^ Nat.log 2 t by exact_mod_cast Nat.pow_log_le_self 2 ht.ne_bot ) ) zero_le_two )