/-
This file was generated by Aristotle (https://aristotle.harmonic.fun).

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 6931d53c-7aed-4c29-9174-ec259534679d

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>
-/

/-
This module defines Leinster groups and proves that no p-group is a Leinster group.

A finite group G is a Leinster group if the sum of the orders of all its normal subgroups equals twice the group's order.
The main theorem `no_pgroup_is_leinster` states that for any prime p, a p-group G with |G| > 1 is not a Leinster group.
The proof uses modular arithmetic, showing that the sum of normal subgroup orders is congruent to 1 mod p, while 2 * |G| is congruent to 0 mod p.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
A finite group G is a Leinster group if the sum of the orders of all its normal subgroups equals twice the group's order.
-/
def IsLeinster (G : Type*) [Group G] [Fintype G] : Prop :=
  ∑ H : {H : Subgroup G // H.Normal}, Nat.card H = 2 * Fintype.card G

/-
No p-group is a Leinster group.
-/
theorem no_pgroup_is_leinster (G : Type*) [Group G] [Fintype G] (p : ℕ) (h_pgroup : IsPGroup p G)
    (hp : Nat.Prime p) (hG : 1 < Fintype.card G) :
    ¬ IsLeinster G := by
      -- Let $p$ be a prime number such that $G$ is a $p$-group.
      have h_p_group : ∀ H : {H : Subgroup G // H.Normal}, Nat.card H ≡ if H.val = ⊥ then 1 else 0 [MOD p] := by
        intro H
        by_cases hH : H.val = ⊥;
        · aesop;
        · -- Since $H$ is a subgroup of $G$ and $G$ is a $p$-group, $H$ must also be a $p$-group.
          have hH_pgroup : IsPGroup p H.val := by
            exact?;
          have := Fact.mk hp; simp_all +decide [ IsPGroup.iff_card ] ;
          rcases hH_pgroup with ⟨ n, hn ⟩ ; rw [ hn ] ; exact Nat.modEq_zero_iff_dvd.mpr ( dvd_pow_self _ ( by rintro rfl; exact hH <| by rw [ Subgroup.eq_bot_iff_card ] ; aesop ) ) ;
      -- Therefore, the sum of the orders of all normal subgroups of $G$ is congruent to $1 \pmod{p}$.
      have h_sum_cong : (∑ H : {H : Subgroup G // H.Normal}, Nat.card H) ≡ 1 [MOD p] := by
        simp_all +decide [ ← ZMod.natCast_eq_natCast_iff ];
        rw [ Finset.sum_eq_single ⟨ ⊥, by infer_instance ⟩ ] <;> aesop;
      -- Since $G$ is a $p$-group, we have $|G| = p^k$ for some $k \geq 1$.
      obtain ⟨k, hk⟩ : ∃ k : ℕ, Fintype.card G = p ^ k := by
        haveI := Fact.mk hp; rw [ IsPGroup.iff_card ] at h_pgroup; aesop;
      unfold IsLeinster; intro H; have := h_sum_cong.symm.trans ( H.symm ▸ Nat.modEq_zero_iff_dvd.mpr ( dvd_mul_of_dvd_right ( hk.symm ▸ dvd_pow_self _ ( by rintro rfl; linarith ) ) _ ) ) ; simp_all +decide [ Nat.ModEq, Nat.mod_eq_of_lt ] ;