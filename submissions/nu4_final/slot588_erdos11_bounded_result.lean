/-
This file was generated by Aristotle (https://aristotle.harmonic.fun).

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 8aaa8d64-1e70-463f-9eb2-3d207e6b81fd

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>
-/

/-
We formalized a bounded verification of Erdős Problem 11.
We defined a decision procedure `hasDecomp` that checks if a number can be written as the sum of a squarefree number and a power of 2.
We proved that `hasDecomp` is correct in `hasDecomp_iff`.
We defined `checkAll` to verify this property for all odd numbers in a range.
We proved `checkAll_correct` which lifts the boolean result to the existential quantifier.
Finally, we proved `erdos_11_bounded_small` which asserts that every odd integer `n` with `1 < n < 10000` satisfies the conjecture, using `native_decide` to execute the check.
This fulfills the user's fallback request for a smaller bound (10^4) as 10^7 is too large for `native_decide`.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

#synth DecidablePred (Squarefree : ℕ → Prop)

#check Nat.log

/-
A boolean function that returns true if n can be written as k + 2^l where k is squarefree.
-/
def hasDecomp (n : ℕ) : Bool :=
  let max_l := Nat.log 2 n
  (List.range (max_l + 1)).any fun l =>
    let k := n - 2^l
    k > 0 && decide (Squarefree k)

/-
Correctness of the decision procedure `hasDecomp`.
-/
theorem hasDecomp_iff (n : ℕ) : hasDecomp n = true ↔ ∃ k l : ℕ, Squarefree k ∧ n = k + 2^l := by
  constructor;
  · unfold hasDecomp;
    grind;
  · rintro ⟨ k, l, hk, rfl ⟩ ; simp +decide [ hasDecomp ] ;
    refine' ⟨ l, _, _, _ ⟩;
    · exact Nat.lt_succ_of_le ( Nat.le_log_of_pow_le ( by norm_num ) ( Nat.le_add_left _ _ ) );
    · exact lt_add_of_pos_left _ ( Nat.pos_of_ne_zero fun h => by simp_all +decide [ Nat.squarefree_iff_prime_squarefree ] );
    · rwa [ Nat.add_sub_cancel ]

/-
A helper function to check the property for all numbers up to a limit.
-/
def checkAll (limit : ℕ) : Bool :=
  (List.range limit).all fun n =>
    if n % 2 == 1 && n > 1 then hasDecomp n else true

/-
Correctness of `checkAll`.
-/
lemma checkAll_correct (limit : ℕ) (h : checkAll limit = true) :
  ∀ n < limit, Odd n → 1 < n → ∃ k l : ℕ, Squarefree k ∧ n = k + 2^l := by
    -- If `checkAll limit` is true, then for all `n` in the list (i.e., `n < limit`), the condition `if n % 2 == 1 && n > 1 then hasDecomp n else true` holds.
    simp [checkAll] at h;
    -- By definition of `hasDecomp`, if `hasDecomp n` is true, then there exist `k` and `l` such that `Squarefree k` and `n = k + 2^l`.
    intros n hn h_odd h_pos
    have h_hasDecomp : hasDecomp n = Bool.true := by
      grind;
    exact hasDecomp_iff n |>.1 h_hasDecomp

/-
Every odd integer n with 1 < n < 10000 can be written as the sum of a squarefree number and a power of 2.
-/
theorem erdos_11_bounded_small (n : ℕ) (hn : Odd n) (h : n < 10000) (hn' : 1 < n) :
    ∃ k l : ℕ, Squarefree k ∧ n = k + 2^l := by
  have h_check : checkAll 10000 = true := by native_decide
  exact checkAll_correct 10000 h_check n h hn hn'